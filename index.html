<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão de Produtos - Bruno Tavares 2025</title>
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    color: #333;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #2563eb;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header button {
    background: #fbbf24;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  header button:hover {
    background: #f59e0b;
  }
  main {
    flex-grow: 1;
    padding: 2rem;
    max-width: 900px;
    margin: auto;
  }
  h1, h2 {
    margin-bottom: 1rem;
  }
  nav {
    margin-bottom: 2rem;
  }
  nav button {
    background: #2563eb;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    margin-right: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  nav button.active, nav button:hover {
    background: #1e40af;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
  }
  th, td {
    border: 1px solid #ddd;
    padding: 0.6rem 1rem;
    text-align: left;
  }
  th {
    background: #2563eb;
    color: white;
  }
  input[type=text], input[type=number] {
    padding: 0.4rem 0.6rem;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-right: 1rem;
    width: 200px;
  }
  input[type=number] {
    max-width: 100px;
  }
  .flex-row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .btn {
    background: #2563eb;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  .btn:hover {
    background: #1e40af;
  }
  footer {
    text-align: center;
    padding: 1rem;
    font-size: 0.9rem;
    background: #f0f0f0;
    margin-top: auto;
  }
  .hidden {
    display: none;
  }
</style>
</head>
<body>

<header>
  <div>
    <strong>Gestão de Produtos</strong>
  </div>
  <div>
    <span id="lastLoginDisplay"></span>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<main>
  <nav>
    <button class="active" data-tab="produtos">Produtos</button>
    <button data-tab="historico">Histórico</button>
    <button data-tab="utilizadores">Utilizadores</button>
  </nav>

  <!-- Login -->
  <section id="loginSection">
    <h2>Iniciar Sessão</h2>
    <div class="flex-row" style="margin-bottom:1rem;">
      <input type="text" id="loginUsername" placeholder="Nome de utilizador" />
      <input type="password" id="loginPassword" placeholder="Palavra-passe" />
      <button class="btn" id="loginBtn">Entrar</button>
    </div>
    <div id="loginMsg" style="color: red;"></div>
  </section>

  <!-- Produtos -->
  <section id="produtosSection" class="hidden">
    <h2>Produtos</h2>
    <div class="flex-row" style="margin-bottom:1rem;">
      <input type="text" id="filterName" placeholder="Pesquisar por nome" />
      <input type="number" id="filterQty" min="0" placeholder="Quantidade inferior a" />
    </div>

    <table aria-label="Tabela de produtos">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Quantidade</th>
          <th>Data da última alteração</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>

    <h3>Adicionar / Editar Produto</h3>
    <div class="flex-row" style="margin-bottom:1rem; gap:0.5rem;">
      <input type="text" id="productName" placeholder="Nome do produto" />
      <input type="number" id="productQty" min="0" placeholder="Quantidade" />
      <button class="btn" id="addEditProductBtn">Adicionar</button>
      <button class="btn hidden" id="cancelEditBtn" style="background:#f87171;">Cancelar</button>
    </div>
  </section>

  <!-- Histórico -->
  <section id="historicoSection" class="hidden">
    <h2>Histórico de Contagens</h2>
    <table aria-label="Histórico de produtos">
      <thead>
        <tr><th>Data</th><th>Produto</th><th>Quantidade</th></tr>
      </thead>
      <tbody id="historicoTable"></tbody>
    </table>
  </section>

  <!-- Utilizadores -->
  <section id="utilizadoresSection" class="hidden">
    <h2>Gestão de Utilizadores</h2>

    <table aria-label="Tabela de utilizadores" style="margin-bottom:1rem;">
      <thead>
        <tr><th>Nome de utilizador</th><th>Último login</th><th>Ações</th></tr>
      </thead>
      <tbody id="utilizadoresTable"></tbody>
    </table>

    <h3>Adicionar Utilizador</h3>
    <div class="flex-row" style="margin-bottom:1rem; gap:0.5rem;">
      <input type="text" id="newUsername" placeholder="Nome de utilizador" />
      <input type="password" id="newPassword" placeholder="Palavra-passe" />
      <button class="btn" id="addUserBtn">Adicionar</button>
    </div>
    <div id="userMsg" style="color:red;"></div>
  </section>
</main>

<footer>
  Criado por Bruno Tavares 2025
</footer>

<script>
  // --- Dados e armazenamento ---
  let currentUser = null;
  let editingProductIndex = null;

  function saveUsers(users) {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function loadUsers() {
    let users = localStorage.getItem('users');
    if (!users) {
      // criar utilizador padrão
      users = [{ username: "admin", password: "admin", lastLogin: null }];
      saveUsers(users);
    } else {
      users = JSON.parse(users);
    }
    return users;
  }

  function saveProducts(products) {
    localStorage.setItem('products', JSON.stringify(products));
  }

  function loadProducts() {
    let products = localStorage.getItem('products');
    if (!products) {
      products = [];
      saveProducts(products);
    } else {
      products = JSON.parse(products);
    }
    return products;
  }

  function saveHistorico(historico) {
    localStorage.setItem('historico', JSON.stringify(historico));
  }

  function loadHistorico() {
    let historico = localStorage.getItem('historico');
    if (!historico) {
      historico = [];
      saveHistorico(historico);
    } else {
      historico = JSON.parse(historico);
    }
    return historico;
  }

  // --- UI e lógica ---
  const loginSection = document.getElementById('loginSection');
  const produtosSection = document.getElementById('produtosSection');
  const historicoSection = document.getElementById('historicoSection');
  const utilizadoresSection = document.getElementById('utilizadoresSection');
  const lastLoginDisplay = document.getElementById('lastLoginDisplay');

  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const logoutBtn = document.getElementById('logoutBtn');

  const filterName = document.getElementById('filterName');
  const filterQty = document.getElementById('filterQty');
  const productTable = document.getElementById('productTable');
  const historicoTable = document.getElementById('historicoTable');

  const productNameInput = document.getElementById('productName');
  const productQtyInput = document.getElementById('productQty');
  const addEditProductBtn = document.getElementById('addEditProductBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');

  const navButtons = document.querySelectorAll('nav button');

  const utilizadoresTable = document.getElementById('utilizadoresTable');
  const newUsernameInput = document.getElementById('newUsername');
  const newPasswordInput = document.getElementById('newPassword');
  const addUserBtn = document.getElementById('addUserBtn');
  const userMsg = document.getElementById('userMsg');

  // --- Funções ---
  function showSection(name) {
    loginSection.classList.add('hidden');
    produtosSection.classList.add('hidden');
    historicoSection.classList.add('hidden');
    utilizadoresSection.classList.add('hidden');

    if (name === 'login') loginSection.classList.remove('hidden');
    else if (name === 'produtos') produtosSection.classList.remove('hidden');
    else if (name === 'historico') historicoSection.classList.remove('hidden');
    else if (name === 'utilizadores') utilizadoresSection.classList.remove('hidden');
  }

  function updateLastLoginDisplay() {
    if (!currentUser) {
      lastLoginDisplay.textContent = "";
      logoutBtn.style.display = "none";
      return;
    }
    lastLoginDisplay.textContent = `Último login: ${currentUser.lastLogin ? currentUser.lastLogin : "Nunca"}`;
    logoutBtn.style.display = "inline-block";
  }

  function renderUsers() {
    const users = loadUsers();
    utilizadoresTable.innerHTML = '';
    users.forEach((u,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.username}</td>
        <td>${u.lastLogin ? u.lastLogin : "Nunca"}</td>
        <td>
          ${u.username === currentUser.username ? '' : `<button data-idx="${i}" class="btn deleteUserBtn" style="background:#f87171;">Eliminar</button>`}
        </td>
      `;
      utilizadoresTable.appendChild(tr);
    });

    document.querySelectorAll('.deleteUserBtn').forEach(btn => {
      btn.onclick = e => {
        const idx = Number(e.target.dataset.idx);
        const users = loadUsers();
        if (users[idx].username === currentUser.username) {
          alert("Não podes eliminar o utilizador atual.");
          return;
        }
        users.splice(idx,1);
        saveUsers(users);
        renderUsers();
      };
    });
  }

  function renderProducts() {
    let products = loadProducts();
    const nameFilter = filterName.value.trim().toLowerCase();
    const qtyFilterRaw = filterQty.value.trim();
    const qtyFilter = qtyFilterRaw === '' ? null : Number(qtyFilterRaw);

    productTable.innerHTML = '';

    products = products.filter(p => {
      const matchName = p.name.toLowerCase().includes(nameFilter);
      const matchQty = qtyFilter === null || p.qty < qtyFilter;
      return matchName && matchQty;
    });

    if (products.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="4" style="text-align:center; font-style: italic;">Nenhum produto encontrado</td>';
      productTable.appendChild(tr);
      return;
    }

    products.forEach((p,i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>${p.updated}</td>
        <td>
          <button class="btn" data-idx="${i}" data-action="edit">Editar</button>
          <button class="btn" style="background:#f87171;" data-idx="${i}" data-action="delete">Eliminar</button>
        </td>
      `;
      productTable.appendChild(tr);
    });

    productTable.querySelectorAll('button').forEach(btn => {
      btn.onclick = e => {
        const idx = Number(e.target.dataset.idx);
        const action = e.target.dataset.action;
        if (action === 'edit') startEditProduct(idx);
        else if (action === 'delete') deleteProduct(idx);
      };
    });
  }

  function renderHistorico() {
    const historico = loadHistorico();
    historicoTable.innerHTML = '';
    if (historico.length === 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td colspan="3" style="text-align:center; font-style: italic;">Sem histórico</td>';
      historicoTable.appendChild(tr);
      return;
    }
    historico.forEach(h => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${h.date}</td>
        <td>${h.product}</td>
        <td>${h.qty}</td>
      `;
      historicoTable.appendChild(tr);
    });
  }

  function loginUser() {
    const username = loginUsername.value.trim();
    const password = loginPassword.value;
    if (!username || !password) {
      loginMsg.textContent = "Preencha todos os campos.";
      return;
    }
    const users = loadUsers();
    const user = users.find(u => u.username === username && u.password === password);
    if (!user) {
      loginMsg.textContent = "Utilizador ou palavra-passe incorretos.";
      return;
    }
    currentUser = user;
    // Atualizar último login
    const nowStr = new Date().toLocaleString('pt-PT');
    const usersUpdated = users.map(u => {
      if (u.username === user.username) {
        return {...u, lastLogin: nowStr};
      }
      return u;
    });
    saveUsers(usersUpdated);
    currentUser.lastLogin = nowStr;

    loginUsername.value = '';
    loginPassword.value = '';
    loginMsg.textContent = '';

    updateLastLoginDisplay();
    showSection('produtos');
    renderProducts();
    renderHistorico();
    renderUsers();
  }

  function logoutUser() {
    currentUser = null;
    updateLastLoginDisplay();
    showSection('login');
  }

  function addEditProduct() {
    const name = productNameInput.value.trim();
    const qtyStr = productQtyInput.value.trim();
    if (!name || qtyStr === '') {
      alert("Preencha nome e quantidade do produto.");
      return;
    }
    const qty = Number(qtyStr);
    if (isNaN(qty) || qty < 0) {
      alert("Quantidade inválida.");
      return;
    }

    let products = loadProducts();
    const nowStr = new Date().toLocaleString('pt-PT');

    if (editingProductIndex !== null) {
      // editar produto
      products[editingProductIndex].name = name;
      products[editingProductIndex].qty = qty;
      products[editingProductIndex].updated = nowStr;
      editingProductIndex = null;
      addEditProductBtn.textContent = "Adicionar";
      cancelEditBtn.classList.add('hidden');
    } else {
      // adicionar novo produto
      products.push({name, qty, updated: nowStr});
    }

    saveProducts(products);

    // Registar no histórico
    const historico = loadHistorico();
    historico.push({date: nowStr, product: name, qty});
    saveHistorico(historico);

    productNameInput.value = '';
    productQtyInput.value = '';

    renderProducts();
    renderHistorico();
  }

  function startEditProduct(idx) {
    const products = loadProducts();
    const p = products[idx];
    productNameInput.value = p.name;
    productQtyInput.value = p.qty;
    addEditProductBtn.textContent = "Guardar";
    cancelEditBtn.classList.remove('hidden');
    editingProductIndex = idx;
  }

  function cancelEdit() {
    editingProductIndex = null;
    productNameInput.value = '';
    productQtyInput.value = '';
    addEditProductBtn.textContent = "Adicionar";
    cancelEditBtn.classList.add('hidden');
  }

  function deleteProduct(idx) {
    if (!confirm("Tem a certeza que pretende eliminar este produto?")) return;
    let products = loadProducts();
    products.splice(idx,1);
    saveProducts(products);
    renderProducts();
  }

  function addUser() {
    userMsg.textContent = '';
    const username = newUsernameInput.value.trim();
    const password = newPasswordInput.value;
    if (!username || !password) {
      userMsg.textContent = "Preencha nome de utilizador e palavra-passe.";
      return;
    }
    const users = loadUsers();
    if (users.find(u => u.username === username)) {
      userMsg.textContent = "Já existe um utilizador com esse nome.";
      return;
    }
    users.push({username, password, lastLogin: null});
    saveUsers(users);
    newUsernameInput.value = '';
    newPasswordInput.value = '';
    renderUsers();
  }

  // --- Eventos ---
  loginBtn.onclick = loginUser;
  logoutBtn.onclick = logoutUser;

  addEditProductBtn.onclick = addEditProduct;
  cancelEditBtn.onclick = cancelEdit;

  filterName.oninput = renderProducts;
  filterQty.oninput = renderProducts;

  addUserBtn.onclick = addUser;

  navButtons.forEach(btn => {
    btn.onclick = () => {
      navButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showSection(btn.dataset.tab);
      if (btn.dataset.tab === 'produtos') renderProducts();
      else if (btn.dataset.tab === 'historico') renderHistorico();
      else if (btn.dataset.tab === 'utilizadores') renderUsers();
    };
  });

  // --- Inicialização ---
  showSection('login');
  updateLastLoginDisplay();

</script>

</body>
</html>
