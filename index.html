<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão Stock & Utilizadores</title>

<!-- Ícones Google Material -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetJS XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  /* Reset e base */
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; padding:0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #4b79a1, #283e51);
    color: #222;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Container geral */
  #container {
    max-width: 1200px;
    margin: 20px auto;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    min-height: 80vh;
    padding: 0;
  }

  header {
    background: #3f51b5;
    color: white;
    padding: 16px 32px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header h1 {
    margin:0; font-weight: 700;
    font-size: 1.8rem;
    letter-spacing: 1px;
  }
  header button {
    background: #ff5252;
    border: none;
    color: white;
    padding: 8px 16px;
    font-weight: 600;
    font-size: 1rem;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.3s ease;
  }
  header button:hover {
    background: #e04848;
  }

  /* Login */
  #loginPage {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    background: white;
    border-radius: 12px;
    padding: 32px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
  }
  #loginPage form {
    width: 320px;
    display: flex;
    flex-direction: column;
  }
  #loginPage h2 {
    text-align: center;
    margin-bottom: 24px;
    color: #3f51b5;
  }
  #loginPage label {
    font-weight: 600;
    margin-bottom: 6px;
    color: #444;
  }
  #loginPage input[type="text"],
  #loginPage input[type="password"] {
    padding: 12px 14px;
    margin-bottom: 16px;
    border-radius: 8px;
    border: 1.8px solid #ccc;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  #loginPage input[type="text"]:focus,
  #loginPage input[type="password"]:focus {
    border-color: #3f51b5;
    outline: none;
  }
  #loginPage button {
    background: #3f51b5;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    padding: 14px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    transition: background 0.3s ease;
  }
  #loginPage button:hover {
    background: #2c3e9f;
  }
  #loginError {
    color: #d32f2f;
    margin-top: 12px;
    text-align: center;
    font-weight: 600;
    display: none;
  }

  /* Tabs */
  #app {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  nav.tabs {
    display: flex;
    background: #f5f7fa;
    border-bottom: 2px solid #ddd;
    user-select: none;
  }
  nav.tabs button {
    flex: 1;
    padding: 14px 0;
    border: none;
    background: transparent;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    color: #555;
    border-bottom: 3px solid transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
  }
  nav.tabs button:hover {
    background: #e0e6f7;
  }
  nav.tabs button.active {
    border-bottom-color: #3f51b5;
    color: #3f51b5;
    font-weight: 700;
    background: #d7defa;
  }

  /* Content Sections */
  section.tabContent {
    flex: 1;
    padding: 24px 32px;
    overflow-y: auto;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px 12px;
    text-align: center;
  }
  th {
    background: #f0f3ff;
    font-weight: 700;
  }
  tbody tr:nth-child(even) {
    background: #f9faff;
  }

  /* Inputs inside table */
  table input[type="text"], table input[type="number"], table select {
    width: 100%;
    padding: 6px 8px;
    font-size: 0.9rem;
    border-radius: 6px;
    border: 1.2px solid #ccc;
    box-sizing: border-box;
  }
  table input[type="number"]::-webkit-inner-spin-button,
  table input[type="number"]::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  table input[type="number"] {
    -moz-appearance: textfield;
  }

  /* Buttons */
  .btn {
    cursor: pointer;
    font-weight: 600;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background 0.3s ease;
    font-size: 0.9rem;
  }
  .btn-primary {
    background: #3f51b5;
    color: white;
  }
  .btn-primary:hover {
    background: #2c3e9f;
  }
  .btn-danger {
    background: #d32f2f;
    color: white;
  }
  .btn-danger:hover {
    background: #a12727;
  }
  .btn-secondary {
    background: #757575;
    color: white;
  }
  .btn-secondary:hover {
    background: #555;
  }

  /* Icon styling */
  .material-icons {
    font-size: 20px;
    vertical-align: middle;
  }

  /* Form controls for checkbox */
  .checkbox-center {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Alerts */
  #alertMsg {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #323232;
    color: white;
    padding: 12px 24px;
    border-radius: 24px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
    font-weight: 600;
    z-index: 999;
  }
  #alertMsg.show {
    opacity: 1;
    pointer-events: auto;
  }

  /* Dashboard Chart */
  #dashboard canvas {
    max-width: 100%;
    height: 300px;
  }

  /* Scroll tables */
  section.tabContent {
    overflow-x: auto;
  }

  /* Footer */
  footer {
    text-align: center;
    font-size: 0.8rem;
    color: #666;
    padding: 12px;
    background: #f0f0f0;
    border-radius: 0 0 12px 12px;
    margin-top: auto;
  }

  /* Responsive */
  @media (max-width: 768px) {
    #container {
      margin: 8px;
    }
    nav.tabs button {
      font-size: 0.9rem;
      padding: 12px 0;
    }
    section.tabContent {
      padding: 16px 12px;
    }
  }
</style>
</head>
<body>

<div id="container">

  <!-- LOGIN PAGE -->
  <div id="loginPage">
    <form id="loginForm" autocomplete="off">
      <h2>Login</h2>
      <label for="loginUser">Utilizador</label>
      <input type="text" id="loginUser" required autofocus />
      <label for="loginPass">Senha</label>
      <input type="password" id="loginPass" required />
      <button type="submit" class="btn btn-primary">
        <span class="material-icons">login</span> Entrar
      </button>
      <p id="loginError">Utilizador ou senha incorretos / inativo.</p>
    </form>
  </div>

  <!-- APP -->
  <div id="app" style="display:none; flex-direction: column; height: 100%;">
    <header>
      <h1><span class="material-icons">inventory_2</span> Gestão Stock</h1>
      <div>
        <span id="loggedUser" style="font-weight:600; margin-right:16px;"></span>
        <button id="logoutBtn" title="Logout" aria-label="Logout" class="btn btn-danger">
          <span class="material-icons">logout</span> Sair
        </button>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Menu principal">
      <button class="active" role="tab" aria-selected="true" aria-controls="tabStock" id="tabBtnStock">
        <span class="material-icons">store</span> Stock
      </button>
      <button role="tab" aria-selected="false" aria-controls="tabUsers" id="tabBtnUsers">
        <span class="material-icons">people</span> Utilizadores
      </button>
      <button role="tab" aria-selected="false" aria-controls="tabDashboard" id="tabBtnDashboard">
        <span class="material-icons">dashboard</span> Dashboard
      </button>
    </nav>

    <section id="tabStock" class="tabContent" role="tabpanel" aria-labelledby="tabBtnStock">
      <div style="margin-bottom:16px; display:flex; gap:10px; flex-wrap: wrap;">
        <input type="text" id="searchProduct" placeholder="Procurar produto..." style="flex-grow:1; padding: 10px; font-size:1rem; border-radius:8px; border:1.5px solid #ccc;" />
        <button class="btn btn-primary" id="btnAddProduct" title="Adicionar Produto">
          <span class="material-icons">add_circle</span> Adicionar Produto
        </button>
        <button class="btn btn-secondary" id="btnResetQuantities" title="Reset Quantidades">
          <span class="material-icons">restart_alt</span> Reset Quantidades
        </button>
        <button class="btn btn-primary" id="btnExportXLSX" title="Exportar para Excel">
          <span class="material-icons">file_download</span> Exportar XLSX
        </button>
        <button class="btn btn-primary" id="btnSaveStock" title="Guardar alterações">
          <span class="material-icons">save</span> Guardar Stock
        </button>
      </div>

      <table aria-label="Tabela de Stock" id="tableStock" role="grid">
        <thead>
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Referência</th>
            <th>Data Última Alteração</th>
            <th>Histórico</th>
            <th>Remover</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="tabUsers" class="tabContent" role="tabpanel" aria-labelledby="tabBtnUsers" hidden>
      <div style="margin-bottom:16px; display:flex; gap:10px; flex-wrap: wrap;">
        <button class="btn btn-primary" id="btnAddUser" title="Adicionar Utilizador">
          <span class="material-icons">person_add</span> Adicionar Utilizador
        </button>
        <button class="btn btn-primary" id="btnSaveUsers" title="Guardar alterações">
          <span class="material-icons">save</span> Guardar Utilizadores
        </button>
      </div>

      <table aria-label="Tabela de Utilizadores" id="tableUsers" role="grid">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nome</th>
            <th>Senha</th>
            <th>Permissão</th>
            <th>Ativo</th>
            <th>Remover</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="tabDashboard" class="tabContent" role="tabpanel" aria-labelledby="tabBtnDashboard" hidden>
      <h2>Dashboard</h2>
      <canvas id="chartStock"></canvas>
    </section>
  </div>
</div>

<footer>
  Produzido por Bruno Tavares 2025
</footer>

<div id="alertMsg"></div>

<script>
  // Estado e dados
  let utilizadores = [];
  let stock = [];
  let currentUser = null;

  // Histórico simples por produto id
  // Cada entrada: { data: ISOString, user: string, acao: string }
  let historicoAlteracoes = {};

  // Inicialização: carregar do localStorage
  function carregarDados() {
    const u = localStorage.getItem('utilizadores');
    const s = localStorage.getItem('stock');
    const h = localStorage.getItem('historicoAlteracoes');

    if(u) utilizadores = JSON.parse(u);
    if(s) stock = JSON.parse(s);
    if(h) historicoAlteracoes = JSON.parse(h);

    // Se não existir utilizadores, criar admin padrão
    if(utilizadores.length === 0) {
      utilizadores = [
        {id: 1, nome: 'admin', senha: 'admin123', permissao: 'admin', ativo: true},
        {id: 2, nome: 'vendedor', senha: 'vend123', permissao: 'vendedor', ativo: true}
      ];
      salvarUtilizadores();
    }

    // Se não existir stock, criar vazio
    if(!stock) stock = [];
    if(!historicoAlteracoes) historicoAlteracoes = {};
  }

  // Salvar dados
  function salvarUtilizadores() {
    localStorage.setItem('utilizadores', JSON.stringify(utilizadores));
  }
  function salvarStock() {
    localStorage.setItem('stock', JSON.stringify(stock));
  }
  function salvarHistorico() {
    localStorage.setItem('historicoAlteracoes', JSON.stringify(historicoAlteracoes));
  }

  // Util - gerar novo ID incremental
  function novoId(array) {
    if(array.length === 0) return 1;
    return Math.max(...array.map(e => e.id)) + 1;
  }

  // Mostra alerta temporário
  function showAlert(msg, duracao=3000) {
    const alertDiv = document.getElementById('alertMsg');
    alertDiv.textContent = msg;
    alertDiv.classList.add('show');
    setTimeout(() => {
      alertDiv.classList.remove('show');
    }, duracao);
  }

  // LOGIN
  const loginForm = document.getElementById('loginForm');
  const loginUser = document.getElementById('loginUser');
  const loginPass = document.getElementById('loginPass');
  const loginError = document.getElementById('loginError');
  const loginPage = document.getElementById('loginPage');
  const app = document.getElementById('app');
  const loggedUserSpan = document.getElementById('loggedUser');

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const nome = loginUser.value.trim();
    const senha = loginPass.value;

    const u = utilizadores.find(u => u.nome === nome && u.senha === senha);
    if(!u || !u.ativo) {
      loginError.style.display = 'block';
      return;
    }
    currentUser = u;
    loginError.style.display = 'none';
    loginPage.style.display = 'none';
    app.style.display = 'flex';
    loggedUserSpan.textContent = `Olá, ${currentUser.nome} (${currentUser.permissao})`;
    carregarTodasTabelas();
    montarGrafico();
  });

  // LOGOUT
  document.getElementById('logoutBtn').addEventListener('click', () => {
    currentUser = null;
    loginUser.value = '';
    loginPass.value = '';
    loginPage.style.display = 'flex';
    app.style.display = 'none';
  });

  // TABS
  const tabsBtns = document.querySelectorAll('nav.tabs button');
  const tabsContent = document.querySelectorAll('section.tabContent');
  tabsBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabsBtns.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-selected', 'true');
      const id = btn.id.replace('Btn', '');
      tabsContent.forEach(tc => {
        if(tc.id === id) {
          tc.hidden = false;
        } else {
          tc.hidden = true;
        }
      });
    });
  });

  // --- GESTÃO STOCK ---
  const tableStockBody = document.querySelector('#tableStock tbody');
  const searchProductInput = document.getElementById('searchProduct');
  const btnAddProduct = document.getElementById('btnAddProduct');
  const btnResetQuantities = document.getElementById('btnResetQuantities');
  const btnSaveStock = document.getElementById('btnSaveStock');
  const btnExportXLSX = document.getElementById('btnExportXLSX');

  function carregarStockTabela(filter = '') {
    tableStockBody.innerHTML = '';
    const f = filter.trim().toLowerCase();
    let filtered = stock;
    if(f) {
      filtered = stock.filter(p => p.nome.toLowerCase().includes(f) || p.referencia.toLowerCase().includes(f));
    }
    if(filtered.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.style.textAlign = 'center';
      td.textContent = 'Nenhum produto encontrado.';
      tr.appendChild(td);
      tableStockBody.appendChild(tr);
      return;
    }
    filtered.forEach(p => {
      const tr = document.createElement('tr');

      // ID
      const tdId = document.createElement('td');
      tdId.textContent = p.id;
      tr.appendChild(tdId);

      // Nome produto
      const tdNome = document.createElement('td');
      const inputNome = document.createElement('input');
      inputNome.type = 'text';
      inputNome.value = p.nome;
      inputNome.title = "Editar nome do produto";
      inputNome.addEventListener('change', () => {
        p.nome = inputNome.value.trim();
        atualizarDataAlteracao(p.id);
      });
      tdNome.appendChild(inputNome);
      tr.appendChild(tdNome);

      // Quantidade
      const tdQtd = document.createElement('td');
      const inputQtd = document.createElement('input');
      inputQtd.type = 'number';
      inputQtd.min = 0;
      inputQtd.value = p.quantidade;
      inputQtd.title = "Editar quantidade";
      inputQtd.addEventListener('change', () => {
        if(inputQtd.value < 0) inputQtd.value = 0;
        p.quantidade = Number(inputQtd.value);
        atualizarDataAlteracao(p.id);
      });
      tdQtd.appendChild(inputQtd);
      tr.appendChild(tdQtd);

      // Referência
      const tdRef = document.createElement('td');
      const inputRef = document.createElement('input');
      inputRef.type = 'text';
      inputRef.value = p.referencia;
      inputRef.title = "Editar referência";
      inputRef.addEventListener('change', () => {
        p.referencia = inputRef.value.trim();
        atualizarDataAlteracao(p.id);
      });
      tdRef.appendChild(inputRef);
      tr.appendChild(tdRef);

      // Data Última Alteração
      const tdData = document.createElement('td');
      tdData.textContent = p.dataUltimaAlteracao ? new Date(p.dataUltimaAlteracao).toLocaleString() : '-';
      tr.appendChild(tdData);

      // Histórico
      const tdHist = document.createElement('td');
      const btnHist = document.createElement('button');
      btnHist.className = 'btn btn-secondary';
      btnHist.title = 'Ver histórico';
      btnHist.innerHTML = '<span class="material-icons">history</span>';
      btnHist.addEventListener('click', () => {
        mostrarHistorico(p.id);
      });
      tdHist.appendChild(btnHist);
      tr.appendChild(tdHist);

      // Remover
      const tdRem = document.createElement('td');
      const btnRem = document.createElement('button');
      btnRem.className = 'btn btn-danger';
      btnRem.title = 'Remover produto';
      btnRem.innerHTML = '<span class="material-icons">delete</span>';
      btnRem.addEventListener('click', () => {
        if(confirm(`Deseja remover o produto "${p.nome}"?`)) {
          stock = stock.filter(prod => prod.id !== p.id);
          delete historicoAlteracoes[p.id];
          salvarStock();
          salvarHistorico();
          carregarStockTabela(searchProductInput.value);
          montarGrafico();
          showAlert('Produto removido');
        }
      });
      tdRem.appendChild(btnRem);
      tr.appendChild(tdRem);

      tableStockBody.appendChild(tr);
    });
  }

  function atualizarDataAlteracao(prodId) {
    const prod = stock.find(p => p.id === prodId);
    if(!prod) return;
    prod.dataUltimaAlteracao = new Date().toISOString();

    // Atualizar histórico
    if(!historicoAlteracoes[prodId]) historicoAlteracoes[prodId] = [];
    historicoAlteracoes[prodId].push({
      data: new Date().toISOString(),
      user: currentUser.nome,
      acao: 'Alteração no produto'
    });

    salvarStock();
    salvarHistorico();
    montarGrafico();
  }

  btnAddProduct.addEventListener('click', () => {
    const novoProduto = {
      id: novoId(stock),
      nome: 'Novo Produto',
      quantidade: 0,
      referencia: '',
      dataUltimaAlteracao: new Date().toISOString()
    };
    stock.push(novoProduto);
    carregarStockTabela(searchProductInput.value);
    montarGrafico();
  });

  btnResetQuantities.addEventListener('click', () => {
    if(confirm('Deseja resetar todas as quantidades para zero?')) {
      stock.forEach(p => {
        p.quantidade = 0;
        p.dataUltimaAlteracao = new Date().toISOString();
        if(!historicoAlteracoes[p.id]) historicoAlteracoes[p.id] = [];
        historicoAlteracoes[p.id].push({
          data: new Date().toISOString(),
          user: currentUser.nome,
          acao: 'Reset da quantidade'
        });
      });
      salvarStock();
      salvarHistorico();
      carregarStockTabela(searchProductInput.value);
      montarGrafico();
      showAlert('Quantidades resetadas');
    }
  });

  btnSaveStock.addEventListener('click', () => {
    salvarStock();
    salvarHistorico();
    showAlert('Stock guardado com sucesso');
  });

  btnExportXLSX.addEventListener('click', () => {
    if(stock.length === 0) {
      showAlert('Stock vazio, nada para exportar');
      return;
    }
    // Formatar dados para exportar
    const exportData = stock.map(p => ({
      ID: p.id,
      Produto: p.nome,
      Quantidade: p.quantidade,
      Referencia: p.referencia,
      'Data Última Alteração': p.dataUltimaAlteracao ? new Date(p.dataUltimaAlteracao).toLocaleString() : ''
    }));
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Stock');
    XLSX.writeFile(wb, 'stock.xlsx');
  });

  searchProductInput.addEventListener('input', () => {
    carregarStockTabela(searchProductInput.value);
  });

  // --- GESTÃO UTILIZADORES ---
  const tableUsersBody = document.querySelector('#tableUsers tbody');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnSaveUsers = document.getElementById('btnSaveUsers');

  function carregarUsersTabela() {
    tableUsersBody.innerHTML = '';
    if(utilizadores.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 6;
      td.style.textAlign = 'center';
      td.textContent = 'Nenhum utilizador encontrado.';
      tr.appendChild(td);
      tableUsersBody.appendChild(tr);
      return;
    }

    utilizadores.forEach(u => {
      const tr = document.createElement('tr');

      // ID
      const tdId = document.createElement('td');
      tdId.textContent = u.id;
      tr.appendChild(tdId);

      // Nome
      const tdNome = document.createElement('td');
      const inputNome = document.createElement('input');
      inputNome.type = 'text';
      inputNome.value = u.nome;
      inputNome.title = 'Editar nome';
      inputNome.addEventListener('change', () => {
        u.nome = inputNome.value.trim();
      });
      tdNome.appendChild(inputNome);
      tr.appendChild(tdNome);

      // Email
      const tdEmail = document.createElement('td');
      const inputEmail = document.createElement('input');
      inputEmail.type = 'email';
      inputEmail.value = u.email;
      inputEmail.title = 'Editar email';
      inputEmail.addEventListener('change', () => {
        u.email = inputEmail.value.trim();
      });
      tdEmail.appendChild(inputEmail);
      tr.appendChild(tdEmail);

      // Permissão
      const tdPerm = document.createElement('td');
      const selectPerm = document.createElement('select');
      ['admin', 'user'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if(u.permissao === role) option.selected = true;
        selectPerm.appendChild(option);
      });
      selectPerm.title = 'Editar permissão';
      selectPerm.addEventListener('change', () => {
        u.permissao = selectPerm.value;
      });
      tdPerm.appendChild(selectPerm);
      tr.appendChild(tdPerm);

      // Password
      const tdPass = document.createElement('td');
      const inputPass = document.createElement('input');
      inputPass.type = 'password';
      inputPass.placeholder = 'Nova senha';
      inputPass.title = 'Alterar senha';
      inputPass.addEventListener('change', () => {
        if(inputPass.value.trim().length > 0) {
          u.password = inputPass.value;
        }
      });
      tdPass.appendChild(inputPass);
      tr.appendChild(tdPass);

      // Remover
      const tdRem = document.createElement('td');
      const btnRem = document.createElement('button');
      btnRem.className = 'btn btn-danger';
      btnRem.title = 'Remover utilizador';
      btnRem.innerHTML = '<span class="material-icons">delete</span>';
      btnRem.addEventListener('click', () => {
        if(confirm(`Deseja remover o utilizador "${u.nome}"?`)) {
          utilizadores = utilizadores.filter(user => user.id !== u.id);
          salvarUtilizadores();
          carregarUsersTabela();
          showAlert('Utilizador removido');
        }
      });
      tdRem.appendChild(btnRem);
      tr.appendChild(tdRem);

      tableUsersBody.appendChild(tr);
    });
  }

  btnAddUser.addEventListener('click', () => {
    const novoUser = {
      id: novoId(utilizadores),
      nome: 'Novo Utilizador',
      email: '',
      permissao: 'user',
      password: ''
    };
    utilizadores.push(novoUser);
    carregarUsersTabela();
  });

  btnSaveUsers.addEventListener('click', () => {
    salvarUtilizadores();
    showAlert('Utilizadores guardados com sucesso');
  });

  // --- Histórico ---
  const modalHistorico = document.getElementById('modalHistorico');
  const historicoContent = document.getElementById('historicoContent');
  const btnCloseHistorico = document.getElementById('btnCloseHistorico');

  function mostrarHistorico(prodId) {
    historicoContent.innerHTML = '';
    const hist = historicoAlteracoes[prodId];
    if(!hist || hist.length === 0) {
      historicoContent.textContent = 'Sem histórico disponível.';
    } else {
      hist.forEach(h => {
        const p = document.createElement('p');
        p.textContent = `[${new Date(h.data).toLocaleString()}] ${h.user}: ${h.acao}`;
        historicoContent.appendChild(p);
      });
    }
    modalHistorico.style.display = 'flex';
  }

  btnCloseHistorico.addEventListener('click', () => {
    modalHistorico.style.display = 'none';
  });

  // --- Gráfico ---
  let chartInstance = null;
  const ctx = document.getElementById('chartStock').getContext('2d');

  function montarGrafico() {
    const labels = stock.map(p => p.nome);
    const data = stock.map(p => p.quantidade);
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Quantidade em Stock',
          data: data,
          backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            precision: 0
          }
        }
      }
    });
  }

  // Funções de armazenamento
  function salvarStock() {
    localStorage.setItem('stock', JSON.stringify(stock));
  }

  function salvarUtilizadores() {
    localStorage.setItem('utilizadores', JSON.stringify(utilizadores));
  }

  function salvarHistorico() {
    localStorage.setItem('historicoAlteracoes', JSON.stringify(historicoAlteracoes));
  }

  // Função para gerar novo ID
  function novoId(arr) {
    if(arr.length === 0) return 1;
    return Math.max(...arr.map(item => item.id)) + 1;
  }

  // Mostrar alertas
  function showAlert(msg) {
    alert(msg);
  }

  // Inicialização
  carregarTodasTabelas();
  montarGrafico();

})();  
  

  
  </script>
</body>
</html>
