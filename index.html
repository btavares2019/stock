<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão Avançada de Stock</title>
<style>
  /* Reset básico */
  * { margin:0; padding:0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
  body {
    background: linear-gradient(135deg, #0077b6, #90e0ef);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px;
    color: #03045e;
  }
  header { font-size: 2rem; font-weight: 700; margin-bottom: 15px; color: #caf0f8; }
  main {
    background: #caf0f8dd; padding: 20px; border-radius: 12px;
    width: 95%; max-width: 1200px; flex-grow: 1; display: flex; flex-direction: column;
  }
  nav {
    margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap;
  }
  nav button {
    background: #0077b6; border: none; color: white; padding: 10px 20px;
    font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center;
    gap: 8px; transition: background-color 0.3s ease;
  }
  nav button:hover, nav button.active {
    background: #023e8a;
  }
  nav button svg { width: 20px; height: 20px; fill: white; }
  section { display: none; flex-direction: column; }
  section.active { display: flex; }
  /* Form */
  label {
    margin: 10px 0 5px; font-weight: 600;
  }
  input[type="text"], input[type="number"], input[type="password"], select {
    padding: 8px 12px; border-radius: 6px; border: 1px solid #0077b6; font-size: 1rem; width: 100%;
  }
  input[type="checkbox"] {
    width: 20px; height: 20px; cursor: pointer;
  }
  table {
    border-collapse: collapse; width: 100%; margin-top: 15px;
    background: white; border-radius: 10px; overflow: hidden;
  }
  th, td {
    border: 1px solid #0077b6cc; padding: 10px; text-align: center; vertical-align: middle;
  }
  th {
    background-color: #0077b6cc; color: white; cursor: pointer;
    user-select: none;
  }
  tr:nth-child(even) { background: #e0f7fa; }
  button.btn {
    background: #0077b6; border: none; color: white; padding: 8px 16px;
    margin: 8px 0; border-radius: 8px; font-weight: 700; cursor: pointer;
    transition: background-color 0.3s ease;
    display: inline-flex; align-items: center; gap: 6px;
  }
  button.btn:hover {
    background: #023e8a;
  }
  .input-group {
    display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;
  }
  .input-group > div {
    flex: 1 1 200px;
  }
  /* Footer */
  footer {
    margin-top: 30px; font-size: 0.9rem; color: #caf0f8cc; user-select:none;
  }
  /* Login */
  #login-section {
    background: white; border-radius: 12px; padding: 25px; width: 100%; max-width: 400px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    display: flex; flex-direction: column;
  }
  #login-section h2 {
    text-align: center; margin-bottom: 20px; color: #0077b6;
  }
  #login-section input {
    margin-bottom: 15px;
  }
  #login-error {
    color: red; font-weight: 700; text-align: center; margin-bottom: 10px;
    display: none;
  }
  /* Responsive */
  @media (max-width: 768px) {
    nav {
      justify-content: center;
    }
    .input-group {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<header>Gestão Avançada de Stock</header>

<div id="login-section">
  <h2>Login</h2>
  <input type="text" id="login-username" placeholder="Usuário" autocomplete="username" />
  <input type="password" id="login-password" placeholder="Senha" autocomplete="current-password" />
  <div id="login-error">Usuário ou senha incorretos.</div>
  <button id="login-btn" class="btn">Entrar</button>
</div>

<main style="display:none;">
  <nav>
    <button id="tab-stock" class="active" title="Stock">
      <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm3 0h13v-2H6v2zm-3 5h2v-2H3v2zm3 0h13v-2H6v2zm-3-10h2V6H3v2zm3 0h13V6H6v2z"/></svg> Stock
    </button>
    <button id="tab-users" title="Utilizadores">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Utilizadores
    </button>
    <button id="tab-dashboard" title="Dashboard">
      <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm10 8h8v-6h-8v6zm0-8h8V3h-8v10z"/></svg> Dashboard
    </button>
    <button id="btn-logout" style="margin-left:auto; background:#d90429;">Logout</button>
  </nav>

  <!-- Stock Section -->
  <section id="stock-section" class="active">
    <h3>Stock</h3>
    <div class="input-group">
      <div>
        <label for="search-stock">Procurar Produto</label>
        <input type="text" id="search-stock" placeholder="Pesquisar..." />
      </div>
      <div>
        <button id="btn-add-stock" class="btn">
          <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M19 13H5v-2h14v2z"/></svg> Adicionar Produto
        </button>
      </div>
      <div>
        <button id="btn-reset-quantities" class="btn" style="background:#f48c06;">
          <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6a6 6 0 1 1-6-6z"/></svg> Reset Quantidades
        </button>
      </div>
      <div>
        <button id="btn-export-stock" class="btn" style="background:#023e8a;">
          <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M5 20h14v-2H5v2zm7-18L5.33 9h3.67v6h4v-6h3.67L12 2z"/></svg> Exportar Excel
        </button>
      </div>
    </div>
    <table id="stock-table" aria-label="Tabela de stock">
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="name">Produto</th>
          <th data-col="quantity">Quantidade</th>
          <th data-col="reference">Referência</th>
          <th data-col="lastModified">Última Alteração</th>
          <th data-col="actions">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Users Section -->
  <section id="users-section">
    <h3>Utilizadores</h3>
    <div class="input-group">
      <div>
        <label for="search-users">Procurar Utilizador</label>
        <input type="text" id="search-users" placeholder="Pesquisar..." />
      </div>
      <div>
        <button id="btn-add-user" class="btn" style="background:#0077b6;">
          <svg viewBox="0 0 24 24" style="width:18px;height:18px;"><path d="M19 13H5v-2h14v2z"/></svg> Adicionar Utilizador
        </button>
      </div>
      <div>
        <button id="btn-save-users" class="btn" style="background:#023e8a;">Guardar Alterações</button>
      </div>
    </div>
    <table id="users-table" aria-label="Tabela de utilizadores">
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <th data-col="username">Nome</th>
          <th data-col="role">Função</th>
          <th data-col="active">Ativo</th>
          <th data-col="actions">Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Dashboard Section -->
  <section id="dashboard-section">
    <h3>Dashboard</h3>
    <canvas id="stock-chart" width="800" height="400" aria-label="Gráfico de stock"></canvas>
  </section>
</main>

<footer>
  Produzido por Bruno Tavares 2025
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // Estado global
  let currentUser = null;
  let stock = [];
  let users = [];
  let sortStockCol = null;
  let sortStockAsc = true;
  let sortUsersCol = null;
  let sortUsersAsc = true;

  // ELEMENTOS
  const loginSection = document.getElementById('login-section');
  const mainSection = document.querySelector('main');
  const loginError = document.getElementById('login-error');
  const loginBtn = document.getElementById('login-btn');
  const usernameInput = document.getElementById('login-username');
  const passwordInput = document.getElementById('login-password');

  const navButtons = {
    stock: document.getElementById('tab-stock'),
    users: document.getElementById('tab-users'),
    dashboard: document.getElementById('tab-dashboard'),
    logout: document.getElementById('btn-logout'),
  };

  const sections = {
    stock: document.getElementById('stock-section'),
    users: document.getElementById('users-section'),
    dashboard: document.getElementById('dashboard-section'),
  };

  // Stock Elements
  const stockTableBody = document.querySelector('#stock-table tbody');
  const searchStockInput = document.getElementById('search-stock');
  const btnAddStock = document.getElementById('btn-add-stock');
  const btnResetQuantities = document.getElementById('btn-reset-quantities');
  const btnExportStock = document.getElementById('btn-export-stock');

  // Users Elements
  const usersTableBody = document.querySelector('#users-table tbody');
  const searchUsersInput = document.getElementById('search-users');
  const btnAddUser = document.getElementById('btn-add-user');
  const btnSaveUsers = document.getElementById('btn-save-users');

  // Dashboard
  const stockChartCtx = document.getElementById('stock-chart').getContext('2d');
  let stockChart = null;

  // ----- Dados iniciais -----
  // Utilizadores padrão
  const defaultUsers = [
    { id: 1, username: 'admin', password: 'admin123', role: 'admin', active: true, lastLogin: null },
    { id: 2, username: 'vendedor', password: 'vend123', role: 'vendedor', active: true, lastLogin: null },
  ];

  // Carregar dados do localStorage
  function loadData() {
    const usersLS = localStorage.getItem('users');
    users = usersLS ? JSON.parse(usersLS) : [...defaultUsers];
    const stockLS = localStorage.getItem('stock');
    stock = stockLS ? JSON.parse(stockLS) : [];
  }

  // Salvar dados
  function saveData() {
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('stock', JSON.stringify(stock));
  }

  // Atualizar UI dos Tabs
  function showSection(name) {
    for (const sec in sections) {
      sections[sec].classList.toggle('active', sec === name);
      navButtons[sec].classList.toggle('active', sec === name);
    }
  }

  // Mostrar erro de login temporariamente
  function showLoginError(show) {
    loginError.style.display = show ? 'block' : 'none';
  }

  // Gerar novo ID único (maior + 1)
  function generateId(collection) {
    if (collection.length === 0) return 1;
    return Math.max(...collection.map(item => item.id)) + 1;
  }

  // --- Login ---
  function login() {
    const user = users.find(u => u.username === usernameInput.value.trim());
    if (!user || user.password !== passwordInput.value || !user.active) {
      showLoginError(true);
      return;
    }
    showLoginError(false);
    currentUser = user;
    currentUser.lastLogin = new Date().toISOString();
    saveData();
    loginSection.style.display = 'none';
    mainSection.style.display = 'flex';
    usernameInput.value = '';
    passwordInput.value = '';
    renderStock();
    renderUsers();
    renderDashboard();
    showSection('stock');
    updateLastLoginDisplay();
  }

  // Logout
  function logout() {
    currentUser = null;
    loginSection.style.display = 'flex';
    mainSection.style.display = 'none';
    showLoginError(false);
  }

  // Atualizar campo último login no footer
  function updateLastLoginDisplay() {
    let footer = document.querySelector('footer');
    if(currentUser) {
      footer.textContent = `Produzido por Bruno Tavares 2025 | Último login: ${new Date(currentUser.lastLogin).toLocaleString()}`;
    } else {
      footer.textContent = 'Produzido por Bruno Tavares 2025';
    }
  }

  // Render Stock Table
  function renderStock() {
    const filter = searchStockInput.value.toLowerCase();
    let filtered = stock.filter(p =>
      p.name.toLowerCase().includes(filter) || p.reference.toLowerCase().includes(filter)
    );

    if(sortStockCol) {
      filtered.sort((a,b) => {
        let valA = a[sortStockCol];
        let valB = b[sortStockCol];
        if(typeof valA === 'string') valA = valA.toLowerCase();
        if(typeof valB === 'string') valB = valB.toLowerCase();
        if(valA > valB) return sortStockAsc ? 1 : -1;
        if(valA < valB) return sortStockAsc ? -1 : 1;
        return 0;
      });
    }

    stockTableBody.innerHTML = '';
    for(const p of filtered) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.id}</td>
        <td contenteditable="true" data-field="name" data-id="${p.id}">${p.name}</td>
        <td contenteditable="true" data-field="quantity" data-id="${p.id}">${p.quantity}</td>
        <td contenteditable="true" data-field="reference" data-id="${p.id}">${p.reference}</td>
        <td>${new Date(p.lastModified).toLocaleString()}</td>
        <td>
          <button class="btn btn-del" data-id="${p.id}" title="Eliminar Produto" style="background:#d90429;">✖</button>
        </td>
      `;
      stockTableBody.appendChild(tr);
    }
  }

  // Render Users Table
  function renderUsers() {
    const filter = searchUsersInput.value.toLowerCase();
    let filtered = users.filter(u =>
      u.username.toLowerCase().includes(filter) || u.role.toLowerCase().includes(filter)
    );

    if(sortUsersCol) {
      filtered.sort((a,b) => {
        let valA = a[sortUsersCol];
        let valB = b[sortUsersCol];
        if(typeof valA === 'string') valA = valA.toLowerCase();
        if(typeof valB === 'string') valB = valB.toLowerCase();
        if(valA > valB) return sortUsersAsc ? 1 : -1;
        if(valA < valB) return sortUsersAsc ? -1 : 1;
        return 0;
      });
    }

    usersTableBody.innerHTML = '';
    for(const u of filtered) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td contenteditable="true" data-field="username" data-id="${u.id}">${u.username}</td>
        <td>
          <select data-field="role" data-id="${u.id}">
            <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
            <option value="vendedor" ${u.role === 'vendedor' ? 'selected' : ''}>Vendedor</option>
            <option value="gestor" ${u.role === 'gestor' ? 'selected' : ''}>Gestor</option>
          </select>
        </td>
        <td>
          <input type="checkbox" data-field="active" data-id="${u.id}" ${u.active ? 'checked' : ''} />
        </td>
        <td>
          ${u.id === 1 ? '<em>Conta padrão</em>' : `<button class="btn btn-del" data-id="${u.id}" style="background:#d90429;">Eliminar</button>`}
        </td>
      `;
      usersTableBody.appendChild(tr);
    }
  }

  // Adicionar Produto
  function addProduct() {
    const newProduct = {
      id: generateId(stock),
      name: 'Novo Produto',
      quantity: 0,
      reference: 'Ref000',
      lastModified: new Date().toISOString(),
    };
    stock.push(newProduct);
    saveData();
    renderStock();
  }

  // Adicionar Utilizador
  function addUser() {
    const newUser = {
      id: generateId(users),
      username: 'novo.utilizador',
      password: '123456', // padrão - pode criar função para mudar depois
      role: 'vendedor',
      active: true,
      lastLogin: null,
    };
    users.push(newUser);
    saveData();
    renderUsers();
  }

  // Guardar alterações do stock (editáveis)
  function saveStockChanges() {
    const tds = stockTableBody.querySelectorAll('td[contenteditable]');
    tds.forEach(td => {
      const id = Number(td.dataset.id);
      const field = td.dataset.field;
      const product = stock.find(p => p.id === id);
      if(product) {
        let val = td.textContent.trim();
        if(field === 'quantity') {
          val = parseInt(val);
          if(isNaN(val) || val < 0) val = 0;
        }
        product[field] = val;
        product.lastModified = new Date().toISOString();
      }
    });
    saveData();
    renderStock();
    renderDashboard();
  }

  // Guardar alterações dos utilizadores
  function saveUserChanges() {
    // Atualiza campos editáveis e selects/checkboxes
    // usernames únicos e não vazios
    const usernameSet = new Set();
    let valid = true;
    // Campos contenteditable username
    const usernameCells = usersTableBody.querySelectorAll('td[contenteditable][data-field="username"]');
    usernameCells.forEach(td => {
      const id = Number(td.dataset.id);
      const user = users.find(u => u.id === id);
      const newName = td.textContent.trim();
      if(!newName || usernameSet.has(newName.toLowerCase())) valid = false;
      usernameSet.add(newName.toLowerCase());
      if(user) user.username = newName;
    });
    // select roles
    const roleSelects = usersTableBody.querySelectorAll('select[data-field="role"]');
    roleSelects.forEach(sel => {
      const id = Number(sel.dataset.id);
      const user = users.find(u => u.id === id);
      if(user) user.role = sel.value;
    });
    // checkboxes active
    const activeChecks = usersTableBody.querySelectorAll('input[type="checkbox"][data-field="active"]');
    activeChecks.forEach(chk => {
      const id = Number(chk.dataset.id);
      const user = users.find(u => u.id === id);
      if(user) user.active = chk.checked;
    });
    if(!valid) {
      alert('Nomes de utilizadores inválidos ou duplicados.');
      renderUsers();
      return;
    }
    saveData();
    renderUsers();
  }

  // Eliminar produto
  function deleteProduct(id) {
    if(!confirm('Tem certeza que deseja eliminar este produto?')) return;
    stock = stock.filter(p => p.id !== id);
    saveData();
    renderStock();
    renderDashboard();
  }

  // Eliminar utilizador
  function deleteUser(id) {
    if(!confirm('Tem certeza que deseja eliminar este utilizador?')) return;
    users = users.filter(u => u.id !== id);
    saveData();
    renderUsers();
  }

  // Reset Quantidades para 0
  function resetQuantities() {
    if(!confirm('Resetar todas as quantidades para zero?')) return;
    stock.forEach(p => p.quantity = 0);
    saveData();
    renderStock();
    renderDashboard();
  }

  // Exportar stock para Excel (simple XLSX com dados básicos)
  function exportStockExcel() {
    // Simplificado: CSV com MIME para Excel abrir, sem dependência externa
    let csvContent = 'data:text/csv;charset=utf-8,';
    csvContent += ['ID','Produto','Quantidade','Referência','Última Alteração'].join(';') + '\r\n';
    stock.forEach(p => {
      csvContent += [p.id, p.name, p.quantity, p.reference, new Date(p.lastModified).toLocaleString()].join(';') + '\r\n';
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `stock_${new Date().toISOString().slice(0,10)}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Atualizar gráfico
  function renderDashboard() {
    if(stockChart) stockChart.destroy();
    const labels = stock.map(p => p.name);
    const data = stock.map(p => p.quantity);
    stockChart = new Chart(stockChartCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Quantidade em Stock',
          data,
          backgroundColor: 'rgba(0, 119, 182, 0.7)',
          borderColor: 'rgba(0, 77, 128, 0.9)',
          borderWidth: 1,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // --- Event Listeners ---
  loginBtn.addEventListener('click', login);
  passwordInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') login();
  });
  navButtons.stock.addEventListener('click', () => showSection('stock'));
  navButtons.users.addEventListener('click', () => showSection('users'));
  navButtons.dashboard.addEventListener('click', () => showSection('dashboard'));
  navButtons.logout.addEventListener('click', logout);

  searchStockInput.addEventListener('input', renderStock);
  searchUsersInput.addEventListener('input', renderUsers);

  btnAddStock.addEventListener('click', () => {
    if(currentUser.role !== 'admin' && currentUser.role !== 'gestor') {
      alert('Permissão negada para adicionar produtos.');
      return;
    }
    addProduct();
  });
  btnAddUser.addEventListener('click', () => {
    if(currentUser.role !== 'admin') {
      alert('Permissão negada para adicionar utilizadores.');
      return;
    }
    addUser();
  });

  btnResetQuantities.addEventListener('click', () => {
    if(currentUser.role !== 'admin' && currentUser.role !== 'gestor') {
      alert('Permissão negada para resetar quantidades.');
      return;
    }
    resetQuantities();
  });

  btnExportStock.addEventListener('click', exportStockExcel);

  btnSaveUsers.addEventListener('click', () => {
    if(currentUser.role !== 'admin') {
      alert('Permissão negada para guardar utilizadores.');
      return;
    }
    saveUserChanges();
  });

  // Eventos para salvar edições na tabela stock on blur
  stockTableBody.addEventListener('blur', e => {
    if(e.target.matches('td[contenteditable]')) {
      saveStockChanges();
    }
  }, true);

  // Eventos para detectar mudança nos selects e checkboxes de utilizadores
  usersTableBody.addEventListener('change', e => {
    if(e.target.matches('select[data-field], input[type="checkbox"][data-field]')) {
      // Salvar diretamente após alteração
      saveUserChanges();
    }
  });

  // Eventos para eliminar produtos e utilizadores (delegação)
  stockTableBody.addEventListener('click', e => {
    if(e.target.matches('button.btn-del')) {
      const id = Number(e.target.dataset.id);
      deleteProduct(id);
    }
  });

  usersTableBody.addEventListener('click', e => {
    if(e.target.matches('button.btn-del')) {
      const id = Number(e.target.dataset.id);
      deleteUser(id);
    }
  });

  // Inicialização
  loadData();
  showSection('login');

})(); 
</script>

</body>
</html>
