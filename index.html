<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestão de Produtos - Criado por Bruno Tavares 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9fafb;
      margin: 0; padding: 0;
      color: #333;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 1rem 2rem;
      font-size: 1.4rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    button {
      cursor: pointer;
      transition: background-color 0.25s ease;
      border: none;
      border-radius: 5px;
      font-weight: 600;
    }
    button:focus {
      outline: 3px solid #93c5fd;
      outline-offset: 2px;
    }
    .tab-btn {
      background: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
    }
    .tab-btn.border-blue-600 {
      border-color: #2563eb;
      color: #1e40af;
    }
    .tab-btn:hover:not(.border-blue-600) {
      color: #2563eb;
    }
    .tab-content {
      padding: 1rem 2rem;
      background: white;
      border-radius: 8px;
      margin: 1rem 2rem 3rem 2rem;
      box-shadow: 0 4px 6px rgb(0 0 0 / 0.1);
    }
    .hidden {
      display: none;
    }
    input[type="text"], input[type="number"], input[type="password"] {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border: 1px solid #d1d5db;
      border-radius: 5px;
      width: 100%;
      max-width: 350px;
      box-sizing: border-box;
      transition: border-color 0.25s ease;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus {
      border-color: #2563eb;
      outline: none;
      box-shadow: 0 0 5px #93c5fd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.6rem 0.75rem;
      text-align: left;
    }
    th {
      background: #2563eb;
      color: white;
      user-select: none;
    }
    tr:hover {
      background-color: #e0e7ff;
    }
    .btn-primary {
      background-color: #2563eb;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-weight: 700;
    }
    .btn-primary:hover {
      background-color: #1e40af;
    }
    .btn-danger {
      background-color: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-weight: 700;
    }
    .btn-danger:hover {
      background-color: #991b1b;
    }
    .btn-warning {
      background-color: #f59e0b;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-weight: 700;
    }
    .btn-warning:hover {
      background-color: #b45309;
    }
    .filter-inputs {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .filter-inputs input {
      flex-grow: 1;
      max-width: 350px;
    }
    footer {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
      padding: 1rem 0;
      user-select: none;
    }
    .login-container {
      max-width: 400px;
      margin: 5rem auto;
      background: white;
      padding: 2rem 2.5rem;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.15);
    }
    .login-container h2 {
      margin-bottom: 1.5rem;
      text-align: center;
      color: #2563eb;
    }
    .login-container label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
      margin-top: 1rem;
    }
    .login-container input {
      width: 100%;
      font-size: 1rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    .login-container button {
      width: 100%;
      margin-top: 1.5rem;
      padding: 0.75rem;
      font-size: 1.1rem;
      background-color: #2563eb;
      color: white;
      font-weight: 700;
      border-radius: 8px;
    }
    .login-container button:hover {
      background-color: #1e40af;
    }
    @media (max-width: 600px) {
      header, .tab-content {
        padding: 1rem;
      }
      .filter-inputs {
        flex-direction: column;
      }
      .filter-inputs input {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <div>Gestão de Produtos</div>
  <div id="headerUserArea"></div>
</header>

<!-- Login -->
<div id="loginScreen" class="login-container">
  <h2>Entrar</h2>
  <label for="loginUser">Nome de utilizador</label>
  <input type="text" id="loginUser" autocomplete="username" />
  <label for="loginPass">Palavra-passe</label>
  <input type="password" id="loginPass" autocomplete="current-password" />
  <button onclick="login()">Entrar</button>
</div>

<!-- Aplicação -->
<div id="app" class="hidden">

  <!-- Abas -->
  <nav style="display:flex; gap:1rem; margin: 1rem 2rem;">
    <button class="tab-btn" id="tab-produtos" onclick="showTab('produtos')">Produtos</button>
    <button class="tab-btn" id="tab-historico" onclick="showTab('historico')">Histórico</button>
    <button class="tab-btn" id="tab-utilizadores" onclick="showTab('utilizadores')">Utilizadores</button>
  </nav>

  <!-- Conteúdos -->
  <section id="produtos" class="tab-content">
    <h2>Produtos</h2>

    <!-- Filtros -->
    <div class="filter-inputs">
      <input id="filterName" type="text" placeholder="Pesquisar por nome..." oninput="renderProducts()" />
      <input id="filterQty" type="number" min="0" placeholder="Quantidade inferior a..." oninput="renderProducts()" />
    </div>

    <div style="margin-bottom:1rem;">
      <input type="text" id="productName" placeholder="Nome do produto" />
      <input type="number" id="productQty" min="0" placeholder="Quantidade" style="width: 120px; margin-left: 1rem;" />
      <button class="btn-primary" onclick="addOrUpdateProduct()">Guardar</button>
    </div>

    <table aria-label="Tabela de produtos">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Quantidade</th>
          <th>Última Alteração</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="productTable"></tbody>
    </table>

    <div style="margin-top: 1rem;">
      <button class="btn-primary" onclick="exportToExcel()">Exportar para Excel</button>
      <button class="btn-primary" onclick="exportToPDF()">Exportar para PDF</button>
      <button class="btn-warning" onclick="window.print()">Imprimir</button>
    </div>
  </section>

  <section id="historico" class="tab-content hidden">
    <h2>Histórico de Contagens</h2>
    <table aria-label="Tabela de histórico">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Quantidade</th>
          <th>Data</th>
          <th>Utilizador</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </section>

  <section id="utilizadores" class="tab-content hidden">
    <h2>Utilizadores</h2>
    <table aria-label="Tabela de utilizadores">
      <thead>
        <tr><th>Nome</th></tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </section>

</div>

<footer>
  Criado por Bruno Tavares 2025
</footer>

<script>
  // Utilizadores fixos
  const fixedUsers = [
    { name: 'admin', password: '1234' },
    { name: 'user2', password: 'abcd' }
  ];

  let currentTab = 'produtos';
  let editingIndex = -1;

  // -----------------------
  // Inicialização
  // -----------------------
  function init() {
    // Verifica se está logado
    const loggedUser = sessionStorage.getItem('loggedUser');
    const lastLogin = sessionStorage.getItem('lastLogin');

    if (loggedUser && lastLogin) {
      showApp(loggedUser, lastLogin);
    } else {
      showLogin();
    }
    renderUsers();
    renderHistory();
    renderProducts();
    showTab(currentTab);
  }

  // -----------------------
  // Mostrar / ocultar e login/logout
  // -----------------------
  function showLogin() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    document.getElementById('headerUserArea').textContent = '';
  }

  function showApp(user, lastLogin) {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    document.getElementById('headerUserArea').textContent = `${user} - Último login: ${lastLogin} `;
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'Logout';
    logoutBtn.className = 'btn-danger';
    logoutBtn.style.marginLeft = '1rem';
    logoutBtn.onclick = logout;
    // Remove logout se existir para não acumular
    const headerArea = document.getElementById('headerUserArea');
    while (headerArea.children.length > 0) headerArea.removeChild(headerArea.children[0]);
    headerArea.textContent = `${user} - Último login: ${lastLogin} `;
    headerArea.appendChild(logoutBtn);
  }

  function login() {
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value;

    if (!username || !password) {
      alert('Por favor, insira nome de utilizador e palavra-passe.');
      return;
    }

    const user = fixedUsers.find(u => u.name === username && u.password === password);

    if (user) {
      const now = new Date().toLocaleString();
      sessionStorage.setItem('loggedUser', user.name);
      sessionStorage.setItem('lastLogin', now);
      showApp(user.name, now);
      // Limpar campos login
      document.getElementById('loginUser').value = '';
      document.getElementById('loginPass').value = '';
      editingIndex = -1;
      renderProducts();
      renderHistory();
      renderUsers();
      showTab(currentTab);
    } else {
      alert('Nome de utilizador ou palavra-passe inválidos.');
    }
  }

  function logout() {
    if (confirm('Quer realmente terminar sessão?')) {
      sessionStorage.removeItem('loggedUser');
      sessionStorage.removeItem('lastLogin');
      showLogin();
    }
  }

  // -----------------------
  // Abas
  // -----------------------
  function showTab(tab) {
    currentTab = tab;

    document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
    document.getElementById(tab).classList.remove('hidden');

    // Atualizar estilos dos botões
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('border-blue-600', 'font-semibold');
      btn.classList.add('hover:text-blue-700');
    });
    document.getElementById('tab-' + tab).classList.add('border-blue-600', 'font-semibold');
    document.getElementById('tab-' + tab).classList.remove('hover:text-blue-700');
  }

  // -----------------------
  // Produtos
  // -----------------------
  function getProducts() {
    return JSON.parse(localStorage.getItem('products') || '[]');
  }

  function setProducts(products) {
    localStorage.setItem('products', JSON.stringify(products));
  }

  function renderProducts() {
    const products = getProducts();

    const filterName = document.getElementById('filterName').value.trim().toLowerCase();
    const filterQtyRaw = document.getElementById('filterQty').value;
    const filterQty = filterQtyRaw === '' ? null : Number(filterQtyRaw);

    const tbody = document.getElementById('productTable');
    tbody.innerHTML = '';

    const filtered = products.filter(p => {
      const nameMatch = p.name.toLowerCase().includes(filterName);
      const qtyMatch = filterQty === null || p.qty < filterQty;
      return nameMatch && qtyMatch;
    });

    filtered.forEach(p => {
      const i = products.indexOf(p);
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-gray-100';

      tr.innerHTML = `
        <td class="border px-4 py-2">${p.name}</td>
        <td class="border px-4 py-2">${p.qty}</td>
        <td class="border px-4 py-2">${p.updated}</td>
        <td class="border px-4 py-2 space-x-2">
          <button onclick="editProduct(${i})" class="bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded transition">Editar</button>
          <button onclick="deleteProduct(${i})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded transition">Apagar</button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  function addOrUpdateProduct() {
    const nameInput = document.getElementById('productName');
    const qtyInput = document.getElementById('productQty');

    const name = nameInput.value.trim();
    const qty = Number(qtyInput.value);

    if (!name) {
      alert('Por favor, insira o nome do produto.');
      return;
    }
    if (!qty || qty < 0) {
      alert('Por favor, insira uma quantidade válida.');
      return;
    }

    const products = getProducts();
    const now = new Date().toLocaleString();
    const user = sessionStorage.getItem('loggedUser') || 'Desconhecido';

    if (editingIndex >= 0) {
      products[editingIndex].name = name;
      products[editingIndex].qty = qty;
      products[editingIndex].updated = now;

      salvarHistorico(name, qty, now, user);

      editingIndex = -1;
    } else {
      products.push({ name, qty, updated: now });
      salvarHistorico(name, qty, now, user);
    }

    setProducts(products);
    renderProducts();

    nameInput.value = '';
    qtyInput.value = '';
  }

  function editProduct(i) {
    const products = getProducts();
    const p = products[i];
    document.getElementById('productName').value = p.name;
    document.getElementById('productQty').value = p.qty;
    editingIndex = i;
    showTab('produtos');
