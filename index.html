<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gest√£o de Stock - Dashboard</title>

<!-- √çcones SVG simples para bot√µes -->
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter&display=swap');
  :root {
    --clr-primary: #2c3e50;
    --clr-secondary: #2980b9;
    --clr-success: #27ae60;
    --clr-danger: #c0392b;
    --clr-warning: #f39c12;
    --clr-light: #ecf0f1;
    --clr-dark: #34495e;
    --clr-bg-light: #f7f9fc;
    --clr-bg-dark: #222831;
    --clr-text-light: #2f3640;
    --clr-text-dark: #dfe6e9;
  }
  body {
    font-family: 'Inter', sans-serif;
    margin: 0; background: var(--clr-bg-light);
    color: var(--clr-text-light);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  body.dark {
    background: var(--clr-bg-dark);
    color: var(--clr-text-dark);
  }
  header {
    background: var(--clr-primary);
    color: white;
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  header.dark {
    background: var(--clr-dark);
  }
  h1 {
    margin: 0; font-weight: 700;
  }
  #themeToggle {
    cursor: pointer;
    background: none; border: none; color: white;
    font-size: 1.5rem;
  }
  #app, #loginSection {
    max-width: 1200px;
    margin: 2rem auto;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    padding: 1.5rem;
    display: none;
  }
  body.dark #app, body.dark #loginSection {
    background: #393e46;
    box-shadow: 0 0 15px rgb(255 255 255 / 0.15);
  }
  #loginSection.active, #app.active {
    display: block;
  }
  .tabs {
    display: flex;
    border-bottom: 2px solid var(--clr-primary);
    margin-bottom: 1rem;
  }
  .tab {
    padding: 0.75rem 1.5rem;
    cursor: pointer;
    font-weight: 600;
    color: var(--clr-primary);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    user-select: none;
  }
  body.dark .tab {
    color: var(--clr-text-dark);
  }
  .tab.active {
    border-color: var(--clr-secondary);
    color: var(--clr-secondary);
  }
  .tab:hover:not(.active) {
    color: var(--clr-secondary);
  }
  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid var(--clr-primary);
    padding: 0.5rem 0.75rem;
    text-align: center;
    font-size: 0.9rem;
  }
  th {
    background: var(--clr-primary);
    color: white;
  }
  body.dark th {
    background: var(--clr-secondary);
  }
  tr.low-stock {
    background: var(--clr-danger);
    color: white;
    font-weight: 700;
  }
  tr:nth-child(even):not(.low-stock) {
    background: var(--clr-light);
  }
  body.dark tr:nth-child(even):not(.low-stock) {
    background: #303841;
  }
  input[type=text], input[type=password], input[type=number], select {
    width: 100%;
    padding: 0.4rem 0.6rem;
    margin: 0.3rem 0;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1rem;
    box-sizing: border-box;
  }
  body.dark input[type=text], body.dark input[type=password], body.dark input[type=number], body.dark select {
    background: #222831;
    border-color: #555;
    color: var(--clr-text-dark);
  }
  button {
    background: var(--clr-secondary);
    border: none;
    color: white;
    padding: 0.6rem 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    margin: 0.3rem 0.2rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: background 0.3s ease;
    user-select: none;
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  button:hover:not(:disabled) {
    background: var(--clr-primary);
  }
  button svg {
    width: 18px; height: 18px;
    fill: currentColor;
  }
  /* Layout grid for forms */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem 1.5rem;
    margin-top: 1rem;
  }
  .form-group {
    display: flex;
    flex-direction: column;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
  }
  /* Notification */
  #notification {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: var(--clr-success);
    color: white;
    padding: 0.8rem 1.2rem;
    border-radius: 6px;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.2);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    font-weight: 600;
    user-select: none;
  }
  #notification.show {
    opacity: 1;
    pointer-events: auto;
  }
  /* Scroll responsive tables */
  .table-container {
    overflow-x: auto;
  }
  /* Dashboard styling */
  #dashboard {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    justify-content: space-around;
  }
  .dashboard-card {
    background: var(--clr-light);
    border-radius: 10px;
    box-shadow: 0 0 8px rgb(0 0 0 / 0.1);
    padding: 1rem 1.5rem;
    flex: 1 1 300px;
    min-width: 280px;
    color: var(--clr-text-light);
  }
  body.dark .dashboard-card {
    background: #2e3338;
    color: var(--clr-text-dark);
  }
  .dashboard-card h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    font-weight: 700;
  }
  /* Footer */
  footer {
    text-align: center;
    font-size: 0.85rem;
    padding: 1rem;
    color: var(--clr-text-light);
    background: var(--clr-primary);
  }
  body.dark footer {
    background: var(--clr-dark);
    color: var(--clr-text-dark);
  }
  /* Responsive */
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    #dashboard {
      flex-direction: column;
    }
    table, th, td {
      font-size: 0.8rem;
    }
  }
</style>

</head>
<body>

<header id="header">
  <h1>Gest√£o de Stock</h1>
  <button id="themeToggle" title="Alternar Tema" aria-label="Alternar Tema">üåô</button>
</header>

<section id="loginSection" class="active" aria-label="√Årea de Login">
  <h2>Login</h2>
  <form id="loginForm" onsubmit="return false;">
    <div class="form-group">
      <label for="loginUsername">Utilizador</label>
      <input type="text" id="loginUsername" autocomplete="username" required />
    </div>
    <div class="form-group">
      <label for="loginPassword">Senha</label>
      <input type="password" id="loginPassword" autocomplete="current-password" required />
    </div>
    <button type="submit" id="loginBtn">
      <svg viewBox="0 0 24 24"><path d="M10 17l5-5-5-5v10z"/></svg> Entrar
    </button>
  </form>
  <p id="loginError" style="color:#c0392b; display:none;">Utilizador ou senha incorretos.</p>
</section>

<section id="app" aria-label="Aplica√ß√£o Principal">
  <nav class="tabs" role="tablist" aria-label="Separadores da aplica√ß√£o">
    <div role="tab" class="tab active" id="tabStockBtn" tabindex="0" aria-selected="true" aria-controls="tabStock">Stock</div>
    <div role="tab" class="tab" id="tabUsersBtn" tabindex="-1" aria-selected="false" aria-controls="tabUsers">Utilizadores</div>
    <div role="tab" class="tab" id="tabDashboardBtn" tabindex="-1" aria-selected="false" aria-controls="tabDashboard">Dashboard</div>
    <div role="tab" class="tab" id="tabHistoryBtn" tabindex="-1" aria-selected="false" aria-controls="tabHistory">Hist√≥rico Altera√ß√µes</div>
    <div style="margin-left:auto;">
      <button id="logoutBtn" title="Sair">
        <svg viewBox="0 0 24 24"><path d="M16 13v-2H7V8l-5 4 5 4v-3zM20 19v-14h-2v14h2z"/></svg> Logout
      </button>
    </div>
  </nav>

  <div id="tabStock" role="tabpanel" aria-labelledby="tabStockBtn" class="tabContent active">
    <h2>Stock</h2>
    <div>
      <input type="text" id="stockSearch" placeholder="Procurar produto..." aria-label="Procurar produto" />
      <button id="btnAddProduct" title="Adicionar Produto">
        <svg viewBox="0 0 24 24"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6v-2z"/></svg> Adicionar Produto
      </button>
      <button id="btnExportXLSX" title="Exportar para Excel XLSX">
        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 19l-4-4 1.41-1.41L8 16.17l7.59-7.59L17 10l-9 9z"/></svg> Exportar XLSX
      </button>
      <button id="btnResetQuantities" title="Resetar Quantidades">
        <svg viewBox="0 0 24 24"><path d="M12 5v7l5 3"/></svg> Reset Quantidades
      </button>
    </div>
    <div class="table-container" style="margin-top:1rem;">
      <table id="stockTable" aria-label="Tabela de stock">
        <thead>
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Refer√™ncia</th>
            <th>Data √öltima Altera√ß√£o</th>
            <th>Stock M√≠nimo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <!-- produtos v√£o aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="tabUsers" role="tabpanel" aria-labelledby="tabUsersBtn" class="tabContent" hidden>
    <h2>Utilizadores</h2>
    <button id="btnAddUser" title="Adicionar Utilizador">
      <svg viewBox="0 0 24 24"><path d="M19 11h-6V5h-2v6H5v2h6v6h2v-6h6v-2z"/></svg> Adicionar Utilizador
    </button>
    <div class="table-container" style="margin-top:1rem;">
      <table id="usersTable" aria-label="Tabela de utilizadores">
        <thead>
          <tr>
            <th>ID</th>
            <th>Utilizador</th>
            <th>Fun√ß√£o</th>
            <th>Ativo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <!-- utilizadores v√£o aqui -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="tabDashboard" role="tabpanel" aria-labelledby="tabDashboardBtn" class="tabContent" hidden>
    <h2>Dashboard</h2>
    <div id="dashboard">
      <div class="dashboard-card" aria-label="Total de produtos">
        <h3>Total de produtos</h3>
        <p id="dashboardTotalProducts" style="font-size:2rem; font-weight:700;">0</p>
      </div>
      <div class="dashboard-card" aria-label="Produtos com stock baixo">
        <h3>Produtos com stock baixo</h3>
        <p id="dashboardLowStock" style="font-size:2rem; font-weight:700;">0</p>
      </div>
      <div class="dashboard-card" aria-label="Utilizadores ativos">
        <h3>Utilizadores ativos</h3>
        <p id="dashboardActiveUsers" style="font-size:2rem; font-weight:700;">0</p>
      </div>
      <div class="dashboard-card" aria-label="Stock total">
        <h3>Stock total</h3>
        <p id="dashboardTotalStock" style="font-size:2rem; font-weight:700;">0</p>
      </div>
    </div>
    <canvas id="chartStockByUser" aria-label="Gr√°fico de stock por utilizador" role="img" style="margin-top:2rem;"></canvas>
  </div>

  <div id="tabHistory" role="tabpanel" aria-labelledby="tabHistoryBtn" class="tabContent" hidden>
    <h2>Hist√≥rico de Altera√ß√µes</h2>
    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
      <table id="historyTable" aria-label="Tabela de hist√≥rico">
        <thead>
          <tr>
            <th>ID Produto</th>
            <th>Produto</th>
            <th>Quantidade Anterior</th>
            <th>Quantidade Atual</th>
            <th>Alterado por</th>
            <th>Data/Hora</th>
          </tr>
        </thead>
        <tbody>
          <!-- hist√≥rico vai aqui -->
        </tbody>
      </table>
    </div>
  </div>
</section>

<div id="notification" role="alert" aria-live="assertive"></div>

<footer>
  Produzido por Bruno Tavares 2025
</footer>

<!-- SheetJS para exportar XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
(() => {
  'use strict';

  // Dados iniciais para testes (ser√° salvo no localStorage)
  const defaultUsers = [
    { id: 1, username: 'admin', password: 'admin123', role: 'admin', active: true },
    { id: 2, username: 'gestor', password: 'gestor123', role: 'gestor', active: true },
    { id: 3, username: 'vendedor', password: 'vend123', role: 'vendedor', active: true },
  ];
  const defaultProducts = [
    { id: 1, name: 'Produto A', quantity: 15, reference: 'REF-A', lastModified: new Date().toISOString(), minStock: 5 },
    { id: 2, name: 'Produto B', quantity: 3, reference: 'REF-B', lastModified: new Date().toISOString(), minStock: 5 },
    { id: 3, name: 'Produto C', quantity: 8, reference: 'REF-C', lastModified: new Date().toISOString(), minStock: 3 },
  ];
  let historyChanges = [];

  // Estado atual
  let currentUser = null;
  let users = [];
  let products = [];

  // DOM refs
  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('app');
  const loginForm = document.getElementById('loginForm');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const loginError = document.getElementById('loginError');
  const notification = document.getElementById('notification');
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tabContent');
  const logoutBtn = document.getElementById('logoutBtn');
  const themeToggle = document.getElementById('themeToggle');

  // Tabelas e bot√µes
  const stockTableBody = document.querySelector('#stockTable tbody');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const historyTableBody = document.querySelector('#historyTable tbody');
  const stockSearchInput = document.getElementById('stockSearch');
  const btnAddProduct = document.getElementById('btnAddProduct');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnExportXLSX = document.getElementById('btnExportXLSX');
  const btnResetQuantities = document.getElementById('btnResetQuantities');

  // Dashboard
  const dashboardTotalProducts = document.getElementById('dashboardTotalProducts');
  const dashboardLowStock = document.getElementById('dashboardLowStock');
  const dashboardActiveUsers = document.getElementById('dashboardActiveUsers');
  const dashboardTotalStock = document.getElementById('dashboardTotalStock');
  const chartCanvas = document.getElementById('chartStockByUser');
  let chartInstance = null;

  // Fun√ß√£o para salvar tudo no localStorage
  function saveAll() {
    localStorage.setItem('stockUsers', JSON.stringify(users));
    localStorage.setItem('stockProducts', JSON.stringify(products));
    localStorage.setItem('stockHistory', JSON.stringify(historyChanges));
  }
  // Fun√ß√£o para carregar tudo do localStorage
  function loadAll() {
    const lsUsers = localStorage.getItem('stockUsers');
    const lsProducts = localStorage.getItem('stockProducts');
    const lsHistory = localStorage.getItem('stockHistory');

    users = lsUsers ? JSON.parse(lsUsers) : defaultUsers.slice();
    products = lsProducts ? JSON.parse(lsProducts) : defaultProducts.slice();
    historyChanges = lsHistory ? JSON.parse(lsHistory) : [];

    saveAll(); // Garantir persist√™ncia padr√£o
  }

  // Mostrar notifica√ß√£o tempor√°ria
  function showNotification(msg, type = 'success') {
    notification.textContent = msg;
    notification.style.backgroundColor = type === 'error' ? 'var(--clr-danger)' : 'var(--clr-success)';
    notification.classList.add('show');
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // Mostrar/ocultar tabs e ajustar foco
  function activateTab(tabId) {
    tabs.forEach(tab => {
      const selected = tab.id === tabId;
      tab.classList.toggle('active', selected);
      tab.setAttribute('aria-selected', selected);
      tab.setAttribute('tabindex', selected ? '0' : '-1');
    });
    tabContents.forEach(tc => {
      tc.hidden = tc.id !== tabId.replace('Btn', '');
      tc.classList.toggle('active', tc.id === tabId.replace('Btn', ''));
    });
  }

  // Controlar acessos baseado no role do utilizador
  function adjustUIByRole() {
    const usersTabBtn = document.getElementById('tabUsersBtn');
    if(currentUser.role !== 'admin'){
      usersTabBtn.style.display = 'none';
    } else {
      usersTabBtn.style.display = 'inline-block';
    }

    // Controlar bot√£o adicionar produto (gestor/admin)
    btnAddProduct.disabled = !['admin','gestor'].includes(currentUser.role);
    btnResetQuantities.disabled = !['admin','gestor'].includes(currentUser.role);
  }

  // Atualizar dashboard
  function updateDashboard(){
    dashboardTotalProducts.textContent = products.length;
    dashboardLowStock.textContent = products.filter(p => p.quantity <= (p.minStock||5)).length;
    dashboardActiveUsers.textContent = users.filter(u => u.active).length;
    dashboardTotalStock.textContent = products.reduce((a,b) => a + b.quantity, 0);

    // Gr√°fico simples por utilizador que alterou produtos
    const stockByUser = {};
    historyChanges.forEach(h => {
      if(h.user){
        stockByUser[h.user] = (stockByUser[h.user] || 0) + (h.newQuantity - h.oldQuantity);
      }
    });

    const labels = Object.keys(stockByUser);
    const data = Object.values(stockByUser);

    if(chartInstance) chartInstance.destroy();

    if(labels.length > 0){
      chartInstance = new Chart(chartCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Altera√ß√µes no stock',
            data,
            backgroundColor: 'rgba(41, 128, 185, 0.7)'
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      chartCanvas.getContext('2d').clearRect(0, 0, chartCanvas.width, chartCanvas.height);
    }
  }

  // Renderizar produtos
  function renderProducts(filter=''){
    stockTableBody.innerHTML = '';
    const f = filter.toLowerCase();
    products.forEach(prod => {
      if(!prod.name.toLowerCase().includes(f) && !prod.reference.toLowerCase().includes(f)) return;

      const tr = document.createElement('tr');
      if(prod.quantity <= (prod.minStock||5)){
        tr.classList.add('low-stock');
      }
      tr.innerHTML = `
        <td>${prod.id}</td>
        <td>${prod.name}</td>
        <td>
          <input type="number" min="0" value="${prod.quantity}" data-id="${prod.id}" ${['admin','gestor'].includes(currentUser.role) ? '' : 'disabled'} />
        </td>
        <td>${prod.reference}</td>
        <td>${new Date(prod.lastModified).toLocaleString()}</td>
        <td>
          <input type="number" min="0" value="${prod.minStock||5}" data-id="${prod.id}" class="minStockInput" ${currentUser.role === 'admin' ? '' : 'disabled'} />
        </td>
        <td>
          <button class="btnSaveProduct" data-id="${prod.id}" title="Guardar">
            <svg viewBox="0 0 24 24"><path d="M17 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zM7 19V5h10v14H7zM9 7h6v2H9V7z"/></svg>
          </button>
        </td>
      `;
      stockTableBody.appendChild(tr);
    });
  }

  // Renderizar utilizadores
  function renderUsers(){
    usersTableBody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td><input type="text" class="userNameInput" data-id="${u.id}" value="${u.username}" ${currentUser.role === 'admin' ? '' : 'disabled'} /></td>
        <td>
          <select class="userRoleSelect" data-id="${u.id}" ${currentUser.role === 'admin' ? '' : 'disabled'}>
            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
            <option value="gestor" ${u.role==='gestor'?'selected':''}>Gestor</option>
            <option value="vendedor" ${u.role==='vendedor'?'selected':''}>Vendedor</option>
          </select>
        </td>
        <td><input type="checkbox" class="userActiveCheckbox" data-id="${u.id}" ${u.active ? 'checked' : ''} ${currentUser.role === 'admin' ? '' : 'disabled'}/></td>
        <td>
          <button class="btnSaveUser" data-id="${u.id}" title="Guardar">
            <svg viewBox="0 0 24 24"><path d="M17 3H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2zM7 19V5h10v14H7zM9 7h6v2H9V7z"/></svg>
          </button>
        </td>
      `;
      usersTableBody.appendChild(tr);
    });
  }

  // Renderizar hist√≥rico
  function renderHistory(filter=''){
    historyTableBody.innerHTML = '';
    const f = filter.toLowerCase();
    historyChanges.forEach(h => {
      if(h.productName.toLowerCase().includes(f) || h.user.toLowerCase().includes(f)){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${h.timestamp}</td>
          <td>${h.productName}</td>
          <td>${h.oldQuantity}</td>
          <td>${h.newQuantity}</td>
          <td>${h.user}</td>
        `;
        historyTableBody.appendChild(tr);
      }
    });
  }

  // Eventos

  // Login
  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = loginUsername.value.trim();
    const password = loginPassword.value.trim();

    const foundUser = users.find(u => u.username === username && u.password === password && u.active);
    if(foundUser){
      currentUser = foundUser;
      loginSection.style.display = 'none';
      appSection.style.display = 'block';
      loginError.textContent = '';
      adjustUIByRole();
      activateTab('tabDashboardBtn');
      renderProducts();
      renderUsers();
      renderHistory();
      updateDashboard();
      showNotification(`Bem-vindo(a), ${currentUser.username}!`);
    } else {
      loginError.textContent = 'Usu√°rio ou senha inv√°lidos, ou usu√°rio inativo.';
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    currentUser = null;
    loginSection.style.display = 'block';
    appSection.style.display = 'none';
    loginUsername.value = '';
    loginPassword.value = '';
  });

  // Trocar tema claro/escuro
  themeToggle.addEventListener('change', () => {
    document.body.classList.toggle('dark-theme', themeToggle.checked);
  });

  // Filtrar produtos na tabela
  stockSearchInput.addEventListener('input', () => {
    renderProducts(stockSearchInput.value);
  });

  // Guardar altera√ß√µes na quantidade e minStock de produtos
  stockTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btnSaveProduct')){
      const id = parseInt(e.target.getAttribute('data-id'));
      const product = products.find(p => p.id === id);
      if(!product) return;

      const row = e.target.closest('tr');
      const quantityInput = row.querySelector('input[type="number"]:not(.minStockInput)');
      const minStockInput = row.querySelector('.minStockInput');

      const oldQuantity = product.quantity;
      const newQuantity = parseInt(quantityInput.value) || 0;
      const newMinStock = parseInt(minStockInput.value) || 5;

      if(newQuantity !== oldQuantity || newMinStock !== product.minStock){
        product.quantity = newQuantity;
        product.minStock = newMinStock;
        product.lastModified = new Date().toISOString();

        // Registar hist√≥rico de altera√ß√µes s√≥ para quantidade
        if(newQuantity !== oldQuantity){
          historyChanges.push({
            timestamp: new Date().toLocaleString(),
            productName: product.name,
            oldQuantity,
            newQuantity,
            user: currentUser.username
          });
        }

        saveAll();
        renderProducts(stockSearchInput.value);
        updateDashboard();
        showNotification(`Produto "${product.name}" atualizado.`);
      }
    }
  });

  // Guardar altera√ß√µes em utilizadores
  usersTableBody.addEventListener('click', e => {
    if(e.target.classList.contains('btnSaveUser')){
      const id = parseInt(e.target.getAttribute('data-id'));
      const user = users.find(u => u.id === id);
      if(!user) return;

      const row = e.target.closest('tr');
      const usernameInput = row.querySelector('.userNameInput');
      const roleSelect = row.querySelector('.userRoleSelect');
      const activeCheckbox = row.querySelector('.userActiveCheckbox');

      user.username = usernameInput.value.trim() || user.username;
      user.role = roleSelect.value;
      user.active = activeCheckbox.checked;

      saveAll();
      renderUsers();
      updateDashboard();
      showNotification(`Utilizador "${user.username}" atualizado.`);
    }
  });

  // Adicionar produto
  btnAddProduct.addEventListener('click', () => {
    const newId = products.length ? Math.max(...products.map(p => p.id)) + 1 : 1;
    const newProduct = {
      id: newId,
      name: `Produto ${newId}`,
      quantity: 0,
      reference: `REF${newId.toString().padStart(3, '0')}`,
      lastModified: new Date().toISOString(),
      minStock: 3
    };
    products.push(newProduct);
    saveAll();
    renderProducts();
    updateDashboard();
    showNotification('Produto adicionado.');
  });

  // Adicionar utilizador
  btnAddUser.addEventListener('click', () => {
    const newId = users.length ? Math.max(...users.map(u => u.id)) + 1 : 1;
    const newUser = {
      id: newId,
      username: `user${newId}`,
      password: '123456',
      role: 'vendedor',
      active: true
    };
    users.push(newUser);
    saveAll();
    renderUsers();
    updateDashboard();
    showNotification('Utilizador adicionado.');
  });

  // Exportar XLSX (Excel)
  btnExportXLSX.addEventListener('click', () => {
    exportToXLSX();
  });

  // Resetar quantidades para 0 (gestor/admin)
  btnResetQuantities.addEventListener('click', () => {
    products.forEach(p => {
      p.quantity = 0;
      p.lastModified = new Date().toISOString();
    });
    historyChanges.push({
      timestamp: new Date().toLocaleString(),
      productName: 'Todos os produtos',
      oldQuantity: null,
      newQuantity: 0,
      user: currentUser.username
    });
    saveAll();
    renderProducts();
    updateDashboard();
    showNotification('Todas as quantidades foram resetadas para 0.');
  });

  // Inicializa√ß√£o
  loadAll();

  // No in√≠cio mostra login
  loginSection.style.display = 'block';
  appSection.style.display = 'none';

  // N√£o deixar abrir app sem login
  if(!currentUser){
    loginSection.style.display = 'block';
    appSection.style.display = 'none';
  }

  // Ativar tab dashboard por padr√£o
  activateTab('tabDashboardBtn');

  // Bot√µes tabs
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      activateTab(tab.id);
    });
  });
  
})();Aqui est√° um sistema completo de gest√£o de stock com login, permiss√µes por papel (admin, gestor, vendedor), painel de controlo, hist√≥rico de altera√ß√µes, e funcionalidades como adicionar produtos/usu√°rios, exportar para Excel e tema claro/escuro.  

**Funcionalidades-chave:**
- Login com valida√ß√£o e papel (role) que controla o acesso e funcionalidades dispon√≠veis.
- Visualiza√ß√£o e edi√ß√£o de produtos com quantidade, stock m√≠nimo e refer√™ncia.
- Gest√£o de utilizadores (admin apenas).
- Hist√≥rico de altera√ß√µes de stock.
- Dashboard com estat√≠sticas e gr√°fico de altera√ß√µes por utilizador (usando Chart.js).
- Exporta√ß√£o para XLSX via SheetJS.
- Tema claro/escuro.
- Filtros de pesquisa em produtos e hist√≥rico.

O c√≥digo j√° est√° pronto para usar localmente. S√≥ precisas de abrir o HTML num navegador moderno para testar. Posso ajudar a adaptar, explicar ou expandir funcionalidades!

---

Quer que te explique alguma parte do c√≥digo? Ou gostarias de ver como exportar para Excel est√° implementado?  
Ou queres que fa√ßa uma vers√£o simplificada s√≥ com o b√°sico?
