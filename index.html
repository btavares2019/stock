<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestão de Stock & Utilizadores</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
  body {
    margin:0; padding:0; font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
    display: flex; flex-direction: column; align-items: center;
  }
  header {
    width: 100%; max-width: 1100px; padding: 1rem 2rem;
    color: white; font-weight: 600; font-size: 1.8rem;
    background: #4a3f6f;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  main {
    background: white;
    max-width: 1100px;
    width: 95%;
    margin: 1.5rem auto 2rem;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 8px 15px rgb(0 0 0 / 0.1);
    flex-grow: 1;
  }
  footer {
    font-size: 0.85rem; color: #eee;
    margin-bottom: 1rem;
  }
  button {
    cursor: pointer;
    background: #667eea;
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #5561d3;
  }
  button:disabled {
    background: #aaa;
    cursor: not-allowed;
  }
  input, select {
    font-size: 1rem;
    padding: 0.4rem 0.6rem;
    border-radius: 6px;
    border: 1px solid #bbb;
    width: 100%;
    box-sizing: border-box;
  }
  input:focus, select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 5px #667eea;
  }
  label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    display: block;
  }
  .hidden {
    display: none !important;
  }
  .flex {
    display: flex;
  }
  .flex-center {
    justify-content: center;
    align-items: center;
  }
  .gap-1 {
    gap: 1rem;
  }
  .gap-0-5 {
    gap: 0.5rem;
  }
  .mb-1 {
    margin-bottom: 1rem;
  }
  .mb-2 {
    margin-bottom: 2rem;
  }
  .mb-0-5 {
    margin-bottom: 0.5rem;
  }
  .mt-1 {
    margin-top: 1rem;
  }
  .mt-0-5 {
    margin-top: 0.5rem;
  }
  .btn-icon {
    font-size: 1.2rem;
  }
  nav {
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #eee;
    display: flex;
    gap: 1rem;
  }
  nav button {
    background: transparent;
    color: #555;
    border-bottom: 3px solid transparent;
    border-radius: 0;
    font-weight: 700;
    font-size: 1rem;
    padding-bottom: 0.3rem;
  }
  nav button.active {
    border-color: #667eea;
    color: #667eea;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 0.9rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 0.5rem 0.7rem;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  tr:nth-child(even) {
    background: #fafafa;
  }
  .checkbox-center {
    display: flex; justify-content: center; align-items: center;
  }
  .input-sm {
    width: 70px;
  }
  .error {
    color: #d8000c;
    background-color: #ffbaba;
    padding: 0.4rem;
    margin-top: 0.3rem;
    border-radius: 6px;
  }
  .success {
    color: #4f8a10;
    background-color: #dff2bf;
    padding: 0.4rem;
    margin-top: 0.3rem;
    border-radius: 6px;
  }
  /* Scroll dentro da tabela */
  .table-wrapper {
    max-height: 320px;
    overflow-y: auto;
  }
  /* Login */
  #loginPage {
    max-width: 400px;
    width: 90%;
    margin: 5rem auto;
    background: white;
    padding: 2rem 3rem;
    border-radius: 10px;
    box-shadow: 0 12px 25px rgb(0 0 0 / 0.15);
  }
  #loginPage h2 {
    text-align: center;
    margin-bottom: 1.8rem;
    color: #4a3f6f;
  }
  #loginPage input {
    margin-bottom: 1rem;
  }
  #loginPage button {
    width: 100%;
  }
  #loginError {
    color: #d8000c;
    font-weight: 700;
    margin-top: 0.5rem;
    display: none;
  }
  /* Dashboard */
  #dashboard {
    margin-bottom: 2rem;
  }
  #dashboard h3 {
    margin-bottom: 1rem;
    color: #4a3f6f;
  }
  /* Icons */
  .icon {
    pointer-events: none;
    user-select: none;
  }
</style>
<!-- Ícones do FontAwesome Free CDN -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>
</head>
<body>

<header>
  Gestão de Stock & Utilizadores
  <button id="logoutBtn" style="float:right; background:#a94442; padding:0.4rem 1rem; border-radius:6px; border:none; color:white; font-weight:600; cursor:pointer; display:none;">
    <i class="fas fa-sign-out-alt"></i> Logout
  </button>
</header>

<div id="loginPage">
  <h2>Iniciar Sessão</h2>
  <label for="loginUsername">Utilizador</label>
  <input type="text" id="loginUsername" autocomplete="username" />
  <label for="loginPassword">Senha</label>
  <input type="password" id="loginPassword" autocomplete="current-password" />
  <button id="btnLogin"><i class="fas fa-right-to-bracket"></i> Entrar</button>
  <p id="loginError">Utilizador ou senha incorretos ou inativos.</p>
</div>

<main class="hidden" id="app">
  <nav>
    <button class="tabButton active" data-tab="stockTab"><i class="fas fa-boxes"></i> Stock</button>
    <button class="tabButton" data-tab="utilizadoresTab"><i class="fas fa-users"></i> Utilizadores</button>
    <button class="tabButton" data-tab="dashboardTab"><i class="fas fa-chart-pie"></i> Dashboard</button>
  </nav>

  <!-- Stock -->
  <section id="stockTab">
    <div class="flex gap-1 mb-1">
      <input type="text" id="searchStock" placeholder="Procurar produto..." />
      <button id="btnAddProduct" title="Adicionar Produto"><i class="fas fa-plus"></i> Adicionar</button>
      <button id="btnSaveStock" title="Guardar alterações"><i class="fas fa-save"></i> Guardar</button>
      <button id="btnExportXLSX" title="Exportar Stock para Excel"><i class="fas fa-file-excel"></i> Exportar XLSX</button>
      <button id="btnResetQtd" title="Resetar quantidades para 0"><i class="fas fa-redo-alt"></i> Reset Qtd</button>
    </div>
    <div class="table-wrapper">
      <table id="stockTable" aria-label="Tabela de Stock">
        <thead>
          <tr>
            <th>ID</th>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Referência</th>
            <th>Data Última Alteração</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p id="stockMsg" class="success hidden">Alterações guardadas com sucesso!</p>
  </section>

  <!-- Utilizadores -->
  <section id="utilizadoresTab" class="hidden">
    <div class="flex gap-1 mb-1">
      <input type="text" id="searchUtilizador" placeholder="Procurar utilizador..." />
      <button id="btnAddUser" title="Adicionar Utilizador"><i class="fas fa-user-plus"></i> Novo</button>
      <button id="btnSaveUsers" title="Guardar alterações"><i class="fas fa-save"></i> Guardar</button>
    </div>
    <div class="table-wrapper">
      <table id="usersTable" aria-label="Tabela de Utilizadores">
        <thead>
          <tr>
            <th>ID</th>
            <th>Utilizador</th>
            <th>Senha</th>
            <th>Ativo</th>
            <th>Permissão</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p id="usersMsg" class="success hidden">Alterações guardadas com sucesso!</p>
  </section>

  <!-- Dashboard -->
  <section id="dashboardTab" class="hidden">
    <h3>Dashboard - Stock</h3>
    <canvas id="stockChart" width="900" height="350"></canvas>
  </section>
</main>

<footer>
  Produzido por Bruno Tavares 2025
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // === Variáveis Globais ===
  const loginPage = document.getElementById('loginPage');
  const app = document.getElementById('app');
  const logoutBtn = document.getElementById('logoutBtn');
  const loginError = document.getElementById('loginError');
  const loginUsername = document.getElementById('loginUsername');
  const loginPassword = document.getElementById('loginPassword');
  const btnLogin = document.getElementById('btnLogin');

  // Tab buttons
  const tabButtons = document.querySelectorAll('.tabButton');

  // Stock
  const stockTableBody = document.querySelector('#stockTable tbody');
  const btnAddProduct = document.getElementById('btnAddProduct');
  const btnSaveStock = document.getElementById('btnSaveStock');
  const btnExportXLSX = document.getElementById('btnExportXLSX');
  const btnResetQtd = document.getElementById('btnResetQtd');
  const searchStock = document.getElementById('searchStock');
  const stockMsg = document.getElementById('stockMsg');

  // Utilizadores
  const utilizadoresTab = document.getElementById('utilizadoresTab');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const btnAddUser = document.getElementById('btnAddUser');
  const btnSaveUsers = document.getElementById('btnSaveUsers');
  const searchUtilizador = document.getElementById('searchUtilizador');
  const usersMsg = document.getElementById('usersMsg');

  // Dashboard
  const dashboardTab = document.getElementById('dashboardTab');
  const stockChartCanvas = document.getElementById('stockChart');
  let stockChart;

  // Dados iniciais (se não existirem no localStorage)
  if (!localStorage.getItem('utilizadores')) {
    const initUsers = [
      {id:1, username:'admin', password:'1234', active:true, permission:'admin'},
      {id:2, username:'vendedor', password:'abcd', active:true, permission:'vendedor'},
      {id:3, username:'gestor', password:'gestor', active:true, permission:'gestor'}
    ];
    localStorage.setItem('utilizadores', JSON.stringify(initUsers));
  }
  if (!localStorage.getItem('stock')) {
    localStorage.setItem('stock', JSON.stringify([]));
  }
  if (!localStorage.getItem('session')) {
    localStorage.setItem('session', '');
  }

  // Função para obter utilizadores e stock do localStorage
  function getUtilizadores() {
    return JSON.parse(localStorage.getItem('utilizadores') || '[]');
  }
  function setUtilizadores(users) {
    localStorage.setItem('utilizadores', JSON.stringify(users));
  }
  function getStock() {
    return JSON.parse(localStorage.getItem('stock') || '[]');
  }
  function setStock(stock) {
    localStorage.setItem('stock', JSON.stringify(stock));
  }
  function setSession(username) {
    localStorage.setItem('session', username);
  }
  function getSession() {
    return localStorage.getItem('session') || '';
  }
  function clearSession() {
    localStorage.setItem('session', '');
  }

  // Mostrar erro/sucesso temporário
  function showMessage(element, msg, type = 'success', timeout=3000) {
    element.textContent = msg;
    element.classList.remove('hidden');
    element.classList.remove('error','success');
    element.classList.add(type);
    setTimeout(() => {
      element.classList.add('hidden');
    }, timeout);
  }

  // Login
  function login() {
    const username = loginUsername.value.trim();
    const password = loginPassword.value;

    const utilizadores = getUtilizadores();
    const user = utilizadores.find(u => u.username === username && u.password === password && u.active);

    if (user) {
      clearLoginForm();
      loginError.style.display = 'none';
      setSession(user.username);
      showApp();
      loadData();
    } else {
      loginError.style.display = 'block';
    }
  }
  btnLogin.onclick = login;

  // Logout
  logoutBtn.onclick = () => {
    clearSession();
    showLogin();
  };

  // Mostrar app e esconder login
  function showApp() {
    loginPage.classList.add('hidden');
    app.classList.remove('hidden');
    logoutBtn.style.display = 'inline-block';
    document.title = 'Gestão de Stock - ' + getSession();
  }
  // Mostrar login e esconder app
  function showLogin() {
    loginPage.classList.remove('hidden');
    app.classList.add('hidden');
    logoutBtn.style.display = 'none';
    document.title = 'Login - Gestão de Stock';
  }

  // Limpar campos login
  function clearLoginForm() {
    loginUsername.value = '';
    loginPassword.value = '';
  }

  // Tabs
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tabId = btn.dataset.tab;
      // esconder todas
      [stockTab, utilizadoresTab, dashboardTab].forEach(sec => {
        sec.classList.add('hidden');
      });
      // mostrar selecionada
      document.getElementById(tabId).classList.remove('hidden');

      if(tabId === 'dashboardTab') {
        renderDashboard();
      }
    });
  });

  // Variáveis para as tabelas
  const stockTab = document.getElementById('stockTab');

  // Criar linha de produto na tabela (modo edição)
  function createStockRow(produto) {
    const tr = document.createElement('tr');

    // ID - só leitura
    const tdId = document.createElement('td');
    tdId.textContent = produto.id;
    tr.appendChild(tdId);

    // Produto - input texto
    const tdProduto = document.createElement('td');
    const inputProduto = document.createElement('input');
    inputProduto.type = 'text';
    inputProduto.value = produto.produto;
    inputProduto.required = true;
    tdProduto.appendChild(inputProduto);
    tr.appendChild(tdProduto);

    // Quantidade - input number
    const tdQtd = document.createElement('td');
    const inputQtd = document.createElement('input');
    inputQtd.type = 'number';
    inputQtd.min = 0;
    inputQtd.value = produto.quantidade;
    inputQtd.classList.add('input-sm');
    tdQtd.appendChild(inputQtd);
    tr.appendChild(tdQtd);

    // Referência - input texto
    const tdRef = document.createElement('td');
    const inputRef = document.createElement('input');
    inputRef.type = 'text';
    inputRef.value = produto.referencia || '';
    tdRef.appendChild(inputRef);
    tr.appendChild(tdRef);

    // Data última alteração - só leitura
    const tdData = document.createElement('td');
    tdData.textContent = produto.dataAlteracao || '-';
    tr.appendChild(tdData);

    // Ações
    const tdAcoes = document.createElement('td');
    tdAcoes.classList.add('flex-center','gap-0-5');

    const btnDel = document.createElement('button');
    btnDel.innerHTML = '<i class="fas fa-trash-alt"></i>';
    btnDel.title = 'Eliminar produto';
    btnDel.style.backgroundColor = '#a94442';
    btnDel.onclick = () => {
      if(confirm(`Eliminar produto "${produto.produto}"?`)) {
        // remover do stock e atualizar tabela
        let stock = getStock();
        stock = stock.filter(p => p.id !== produto.id);
        setStock(stock);
        renderStockTable(stock);
        showMessage(stockMsg, 'Produto eliminado.', 'success', 2000);
      }
    };
    tdAcoes.appendChild(btnDel);
    tr.appendChild(tdAcoes);

    // Guardar referências para salvar depois
    tr.inputs = {inputProduto, inputQtd, inputRef, tdData};

    return tr;
  }

  // Renderizar tabela de stock
  function renderStockTable(stock) {
    stockTableBody.innerHTML = '';
    stock.forEach(produto => {
      stockTableBody.appendChild(createStockRow(produto));
    });
  }

  // Renderizar tabela utilizadores
  function renderUsersTable(users) {
    usersTableBody.innerHTML = '';
    users.forEach(user => {
      usersTableBody.appendChild(createUserRow(user));
    });
  }

  // Criar linha de utilizador
  function createUserRow(user) {
    const tr = document.createElement('tr');

    // ID
    const tdId = document.createElement('td');
    tdId.textContent = user.id;
    tr.appendChild(tdId);

    // Utilizador - input texto
    const tdUsername = document.createElement('td');
    const inputUsername = document.createElement('input');
    inputUsername.type = 'text';
    inputUsername.value = user.username;
    inputUsername.required = true;
    tdUsername.appendChild(inputUsername);
    tr.appendChild(tdUsername);

    // Senha - input password
    const tdPass = document.createElement('td');
    const inputPass = document.createElement('input');
    inputPass.type = 'password';
    inputPass.value = user.password;
    inputPass.required = true;
    tdPass.appendChild(inputPass);
    tr.appendChild(tdPass);

    // Ativo - checkbox
    const tdActive = document.createElement('td');
    tdActive.classList.add('checkbox-center');
    const checkboxActive = document.createElement('input');
    checkboxActive.type = 'checkbox';
    checkboxActive.checked = !!user.active;
    tdActive.appendChild(checkboxActive);
    tr.appendChild(tdActive);

    // Permissão - select
    const tdPerm = document.createElement('td');
    const selectPerm = document.createElement('select');
    ['admin','vendedor','gestor'].forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p.charAt(0).toUpperCase() + p.slice(1);
      if (user.permission === p) opt.selected = true;
      selectPerm.appendChild(opt);
    });
    tdPerm.appendChild(selectPerm);
    tr.appendChild(tdPerm);

    // Ações
    const tdAcoes = document.createElement('td');
    tdAcoes.classList.add('flex-center','gap-0-5');

    const btnDel = document.createElement('button');
    btnDel.innerHTML = '<i class="fas fa-trash-alt"></i>';
    btnDel.title = 'Eliminar utilizador';
    btnDel.style.backgroundColor = '#a94442';
    btnDel.onclick = () => {
      if(user.username === getSession()){
        alert('Não pode eliminar o utilizador logado.');
        return;
      }
      if(confirm(`Eliminar utilizador "${user.username}"?`)) {
        let users = getUtilizadores();
        users = users.filter(u => u.id !== user.id);
        setUtilizadores(users);
        renderUsersTable(users);
        showMessage(usersMsg, 'Utilizador eliminado.', 'success', 2000);
      }
    };
    tdAcoes.appendChild(btnDel);
    tr.appendChild(tdAcoes);

    tr.inputs = {inputUsername, inputPass, checkboxActive, selectPerm};
    return tr;
  }

  // Adicionar novo produto vazio na tabela
  btnAddProduct.onclick = () => {
    const stock = getStock();
    const novoId = stock.length ? Math.max(...stock.map(p=>p.id)) + 1 : 1;
    const novoProduto = {
      id: novoId,
      produto: '',
      quantidade: 0,
      referencia: '',
      dataAlteracao: '-'
    };
    stock.push(novoProduto);
    setStock(stock);
    renderStockTable(stock);
  };

  // Adicionar novo utilizador vazio
  btnAddUser.onclick = () => {
    const users = getUtilizadores();
    const novoId = users.length ? Math.max(...users.map(u=>u.id)) + 1 : 1;
    const novoUser = {
      id: novoId,
      username: '',
      password: '',
      active: true,
      permission: 'vendedor'
    };
    users.push(novoUser);
    setUtilizadores(users);
    renderUsersTable(users);
  };

  // Salvar stock (validar e atualizar localStorage)
  btnSaveStock.onclick = () => {
    let stock = getStock();
    let valid = true;
    const erros = [];

    // Pega as linhas atuais na tabela e atualiza stock
    const rows = [...stockTableBody.querySelectorAll('tr')];
    rows.forEach((tr, i) => {
      const {inputProduto, inputQtd, inputRef, tdData} = tr.inputs;
      const id = stock[i].id;
      const produtoNome = inputProduto.value.trim();
      const qtd = Number(inputQtd.value);
      const referencia = inputRef.value.trim();

      if (!produtoNome) {
        valid = false;
        erros.push(`Linha ${i+1}: Produto não pode estar vazio.`);
      }

      // Verificar nomes duplicados
      const nomes = rows.map(r => r.inputs.inputProduto.value.trim().toLowerCase());
      const nomeCount = nomes.filter(n => n === produtoNome.toLowerCase()).length;
      if (nomeCount > 1) {
        valid = false;
        erros.push(`Linha ${i+1}: Produto "${produtoNome}" está duplicado.`);
      }

      if (qtd < 0) {
        valid = false;
        erros.push(`Linha ${i+1}: Quantidade não pode ser negativa.`);
      }

      // Atualiza objeto
      stock[i] = {
        id,
        produto: produtoNome,
        quantidade: qtd,
        referencia,
        dataAlteracao: new Date().toLocaleString()
      };
      tdData.textContent = stock[i].dataAlteracao;
    });

    if (!valid) {
      alert('Erros:\n' + erros.join('\n'));
      return;
    }
    setStock(stock);
    showMessage(stockMsg, 'Stock guardado com sucesso!');
  };

  // Salvar utilizadores (validar e atualizar localStorage)
  btnSaveUsers.onclick = () => {
    let users = getUtilizadores();
    let valid = true;
    const erros = [];

    const rows = [...usersTableBody.querySelectorAll('tr')];
    rows.forEach((tr,i) => {
      const {inputUsername, inputPass, checkboxActive, selectPerm} = tr.inputs;
      const id = users[i].id;
      const username = inputUsername.value.trim();
      const password = inputPass.value;
      const active = checkboxActive.checked;
      const permission = selectPerm.value;

      if (!username) {
        valid = false;
        erros.push(`Linha ${i+1}: Utilizador não pode estar vazio.`);
      }
      if (!password) {
        valid = false;
        erros.push(`Linha ${i+1}: Senha não pode estar vazia.`);
      }

      // Verificar usernames duplicados
      const usernames = rows.map(r => r.inputs.inputUsername.value.trim().toLowerCase());
      const count = usernames.filter(u => u === username.toLowerCase()).length;
      if(count > 1) {
        valid = false;
        erros.push(`Linha ${i+1}: Utilizador "${username}" está duplicado.`);
      }

      users[i] = {id, username, password, active, permission};
    });

    if(!valid) {
      alert('Erros:\n' + erros.join('\n'));
      return;
    }

    setUtilizadores(users);
    showMessage(usersMsg, 'Utilizadores guardados com sucesso!');
  };

  // Pesquisar stock
  searchStock.addEventListener('input', () => {
    const termo = searchStock.value.trim().toLowerCase();
    const stock = getStock();
    const filtrado = stock.filter(p => p.produto.toLowerCase().includes(termo));
    renderStockTable(filtrado);
  });

  // Pesquisar utilizadores
  searchUtilizador.addEventListener('input', () => {
    const termo = searchUtilizador.value.trim().toLowerCase();
    const users = getUtilizadores();
    const filtrado = users.filter(u => u.username.toLowerCase().includes(termo));
    renderUsersTable(filtrado);
  });

  // Inicialização
  function init() {
    // Carregar stock e utilizadores
    let stock = getStock();
    if(!stock.length) {
      stock = [
        {id: 1, produto: 'Arroz', quantidade: 100, referencia: 'ARZ001', dataAlteracao: '-'},
        {id: 2, produto: 'Feijão', quantidade: 50, referencia: 'FJA002', dataAlteracao: '-'}
      ];
      setStock(stock);
    }
    renderStockTable(stock);

    let users = getUtilizadores();
    if(!users.length) {
      users = [
        {id: 1, username: 'admin', password: 'admin', active: true, permission: 'admin'}
      ];
      setUtilizadores(users);
    }
    renderUsersTable(users);

    // Mostrar utilizador logado
    userLogged.textContent = getSession() || 'Nenhum utilizador logado';
  }

  init();

})();  
</script>

</body>
</html>
