<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GestÃ£o de Stock</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #3498db;
      --danger: #e74c3c;
      --success: #2ecc71;
      --background: #f9f9f9;
      --dark: #2c3e50;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: var(--background);
    }

    header, footer {
      text-align: center;
      background: var(--dark);
      color: white;
      padding: 10px 0;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    h2 {
      color: var(--dark);
    }

    input, select, button {
      padding: 8px;
      margin: 4px 0;
      width: 100%;
      box-sizing: border-box;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    th {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button.danger { background: var(--danger); }
    button.success { background: var(--success); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }

    .low-stock {
      background-color: #ffe6e6;
    }

    .hidden {
      display: none;
    }

    .flex {
      display: flex;
      gap: 10px;
    }

    .flex input {
      flex: 1;
    }

    @media (max-width: 768px) {
      .flex {
        flex-direction: column;
      }
    }

    footer small {
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <header>
    <h1>GestÃ£o de Stock</h1>
  </header>

  <div class="container">
    <div id="login" class="card">
      <h2>Login</h2>
      <input type="text" id="loginUser" placeholder="Utilizador">
      <input type="password" id="loginPass" placeholder="Senha">
      <button onclick="login()">Entrar</button>
      <p id="loginError" style="color:red; display:none;">Credenciais invÃ¡lidas ou utilizador inativo.</p>
    </div>

    <div id="app" class="card hidden">
      <div class="flex">
        <button onclick="logout()">ðŸšª Sair</button>
        <button onclick="showUserManagement()">ðŸ‘¤ GestÃ£o de Utilizadores</button>
        <button onclick="addProduct()">âž• Adicionar Produto</button>
        <button onclick="exportToExcel()">ðŸ“¤ Exportar</button>
        <button onclick="loadProductList()">ðŸ“¥ Carregar Lista</button>
        <button onclick="resetQuantities()">ðŸ”„ Reset Quantidades</button>
      </div>

      <input type="text" id="searchInput" placeholder="Pesquisar produto..." onkeyup="searchProducts()">
      <input type="number" id="filterQuantity" placeholder="Quantidade menor que..." oninput="filterByQuantity()">

      <table id="productTable">
        <thead>
          <tr>
            <th onclick="sortTable('id')">ID</th>
            <th onclick="sortTable('produto')">Produto</th>
            <th onclick="sortTable('quantidade')">Quantidade</th>
            <th onclick="sortTable('referencia')">ReferÃªncia</th>
            <th onclick="sortTable('data')">Ãšltima AlteraÃ§Ã£o</th>
            <th>AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <canvas id="stockChart" height="100"></canvas>
    </div>

    <div id="userManagement" class="card hidden">
      <h2>GestÃ£o de Utilizadores</h2>
      <div class="flex">
        <input type="text" id="newUsername" placeholder="Novo utilizador">
        <input type="password" id="newPassword" placeholder="Senha">
        <select id="newRole">
          <option value="admin">Admin</option>
          <option value="vendedor">Vendedor</option>
          <option value="gestor">Gestor</option>
        </select>
        <button onclick="addUser()">âž• Criar</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Utilizador</th>
            <th>PermissÃ£o</th>
            <th>Ativo</th>
            <th>AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>
  </div>

  <footer>
    <small>Produzido por Bruno Tavares 2025</small>
  </footer>

  <script>
    // Dados simulados
    let users = JSON.parse(localStorage.getItem('users')) || [
      { username: 'admin', password: 'admin', role: 'admin', active: true }
    ];

    let products = JSON.parse(localStorage.getItem('products')) || [];
    let currentUser = null;

    function login() {
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPass').value;
      const found = users.find(u => u.username === user && u.password === pass && u.active);

      if (found) {
        currentUser = found;
        localStorage.setItem('lastLogin', found.username);
        document.getElementById('login').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        renderProducts();
        renderChart();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('login').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
      document.getElementById('userManagement').classList.add('hidden');
    }

    function renderProducts() {
      const tbody = document.querySelector('#productTable tbody');
      tbody.innerHTML = '';
      products.forEach(p => {
        const row = tbody.insertRow();
        if (p.quantidade <= 5) row.classList.add('low-stock');
        row.innerHTML = `
          <td>${p.id}</td>
          <td>${p.produto}</td>
          <td><input type="number" value="${p.quantidade}" onchange="updateQuantity(${p.id}, this.value)"></td>
          <td>${p.referencia}</td>
          <td>${p.data}</td>
          <td>
            <button onclick="deleteProduct(${p.id})" class="danger">ðŸ—‘</button>
          </td>
        `;
      });
    }

    function updateQuantity(id, value) {
      const product = products.find(p => p.id === id);
      if (product) {
        product.quantidade = parseInt(value);
        product.data = new Date().toLocaleString();
        saveProducts();
        renderProducts();
        renderChart();
      }
    }

    function addProduct() {
      const nome = prompt("Nome do produto:");
      if (!nome) return;
      if (products.some(p => p.produto.toLowerCase() === nome.toLowerCase())) {
        alert("Produto jÃ¡ existe.");
        return;
      }
      const quantidade = parseInt(prompt("Quantidade inicial:") || "0");
      const referencia = prompt("ReferÃªncia:") || "";
      const id = Date.now();
      const data = new Date().toLocaleString();
      products.push({ id, produto: nome, quantidade, referencia, data });
      saveProducts();
      renderProducts();
      renderChart();
    }

    function deleteProduct(id) {
      if (confirm("Deseja eliminar este produto?")) {
        products = products.filter(p => p.id !== id);
        saveProducts();
        renderProducts();
        renderChart();
      }
    }

    function searchProducts() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll("#productTable tbody tr").forEach(row => {
        const text = row.cells[1].textContent.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    }

    function exportToExcel() {
      let csv = "ID,Produto,Quantidade,ReferÃªncia,Data\n";
      products.forEach(p => {
        csv += `${p.id},${p.produto},${p.quantidade},${p.referencia},${p.data}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "stock.csv";
      a.click();
    }

    function loadProductList() {
      const sample = [
        { id: Date.now()+1, produto: "Cabo USB", quantidade: 10, referencia: "A001", data: new Date().toLocaleString() },
        { id: Date.now()+2, produto: "Adaptador HDMI", quantidade: 3, referencia: "B002", data: new Date().toLocaleString() }
      ];
      products = products.concat(sample);
      saveProducts();
      renderProducts();
      renderChart();
    }

    function resetQuantities() {
      if (confirm("Resetar todas as quantidades para 0?")) {
        products.forEach(p => {
          p.quantidade = 0;
          p.data = new Date().toLocaleString();
        });
        saveProducts();
        renderProducts();
        renderChart();
      }
    }

    function filterByQuantity() {
      const max = parseInt(document.getElementById("filterQuantity").value || "0");
      document.querySelectorAll("#productTable tbody tr").forEach(row => {
        const qty = parseInt(row.cells[2].querySelector("input").value);
        row.style.display = (!max || qty < max) ? "" : "none";
      });
    }

    function renderChart() {
      const ctx = document.getElementById('stockChart').getContext('2d');
      const labels = products.map(p => p.produto);
      const data = products.map(p => p.quantidade);
      if (window.stockChart) window.stockChart.destroy();
      window.stockChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Quantidade em Stock',
            data,
            backgroundColor: '#3498db'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } }
        }
      });
    }

    function showUserManagement() {
      document.getElementById('userManagement').classList.toggle('hidden');
      renderUsers();
    }

    function renderUsers() {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      users.forEach((u, i) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${u.username}</td>
          <td>${u.role}</td>
          <td><input type="checkbox" ${u.active ? 'checked' : ''} onchange="toggleActive(${i})"></td>
          <td><button onclick="deleteUser(${i})" class="danger">ðŸ—‘</button></td>
        `;
      });
    }

    function addUser() {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;
      if (!username || !password) return alert("Preencha todos os campos.");
      if (users.some(u => u.username === username)) return alert("Utilizador jÃ¡ existe.");
      users.push({ username, password, role, active: true });
      saveUsers();
      renderUsers();
    }

    function deleteUser(i) {
      if (confirm("Eliminar utilizador?")) {
        users.splice(i, 1);
        saveUsers();
        renderUsers();
      }
    }

    function toggleActive(i) {
      users[i].active = !users[i].active;
      saveUsers();
    }

    function saveUsers() {
      localStorage.setItem("users", JSON.stringify(users));
    }

    function saveProducts() {
      localStorage.setItem("products", JSON.stringify(products));
    }

    window.onload = () => {
      const lastUser = localStorage.getItem('lastLogin');
      if (lastUser) document.getElementById("loginUser").value = lastUser;
    }
  </script>
</body>
</html>
